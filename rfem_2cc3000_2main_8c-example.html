<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>BSP430: rfem/cc3000/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BSP430
   &#160;<span id="projectnumber">20130427</span>
   </div>
   <div id="projectbrief">Board Support Package for MSP430 microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">rfem/cc3000/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="platform_8h.html" title="Entrypoint for platform-specific capabilities.">bsp430/platform.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="clock_8h.html" title="Clock-related functions implemented on all MSP430 MCUs.">bsp430/clock.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="port_8h.html" title="Hardware presentation/abstraction for Digital I/O Port (PORT#/PORT#_R)">bsp430/periph/port.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sys_8h.html" title="Hardware presentation/abstraction for SYS peripheral (SYS).">bsp430/periph/sys.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="flash_8h.html" title="Hardware presentation/abstraction for flash memory peripheral (FLASH).">bsp430/periph/flash.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/crtld.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="uptime_8h.html" title="Support for maintaining a system uptime counter.">bsp430/utility/uptime.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="console_8h.html" title="A generic console output capability.">bsp430/utility/console.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="led_8h.html" title="Support for platform-independent LED manipulation.">bsp430/utility/led.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cli_8h.html" title="Basic support for command line processing.">bsp430/utility/cli.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="cc3000spi_8h.html" title="CC3000 Host Driver Interface for BSP430.">cc3000spi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/wlan.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/nvmem.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/netapp.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;ctype.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Memory is extremely tight on the FR5739 (16 kB including CC3000</span></div>
<div class="line"><span class="comment"> * buffers).  Set these to restrict the set of commands to ones of</span></div>
<div class="line"><span class="comment"> * interest that will fit.  You&#39;ll probably find you&#39;ll need to</span></div>
<div class="line"><span class="comment"> * disable WLAN_CONNECT, which makes this pretty useless.  On the</span></div>
<div class="line"><span class="comment"> * EXP430F5438 the total application size is just over 20 kB. */</span></div>
<div class="line"><span class="preprocessor">#define CMD_WLAN 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_WLAN_STOP 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_WLAN_STATUS 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_WLAN_CONNECT 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_WLAN_IPCONFIG 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_WLAN_DISCONNECT 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_WLAN_START 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_NVMEM 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_NVMEM_SP 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_NVMEM_READ 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_NVMEM_MAC 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_INFO 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_HELP 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if NO_HELP - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define HELP_STRING(h_) NULL</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* NO_HELP */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define HELP_STRING(h_) h_</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* NO_HELP */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MAGIC_CONNECT_PARAMS 0x3000</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>sConnectParams {</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> magic;</div>
<div class="line">  <span class="keywordtype">int</span> security_type;</div>
<div class="line">  <span class="keywordtype">size_t</span> ssid_len;</div>
<div class="line">  <span class="keywordtype">size_t</span> passphrase_len;</div>
<div class="line">  <span class="keywordtype">char</span> ssid[33];</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> passphrase[65];</div>
<div class="line">} sConnectParams;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> wlan_cb (<span class="keywordtype">long</span> event_type,</div>
<div class="line">                     <span class="keywordtype">char</span> * data,</div>
<div class="line">                     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> length)</div>
<div class="line">{</div>
<div class="line">  <a name="a0"></a><a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%s wlan_cb %#lx %u at %p SR %#x\n&quot;</span>,</div>
<div class="line">          <a name="a1"></a><a class="code" href="uptime_8h.html#a790fc3c41c4a8e93ec7caca7825733c1">xBSP430uptimeAsText_ni</a>(<a name="a2"></a><a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>()),</div>
<div class="line">          event_type, length, data, __read_status_register());</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <a name="_a3"></a><a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> * commandSet;</div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND NULL</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND NULL</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_STOP - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_stop (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  wlan_stop();</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_stop = {</div>
<div class="line">  .<a name="a4"></a><a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;stop&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# shut down CC3000&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a name="a5"></a><a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_stop</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_stop</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_STOP */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_DISCONNECT - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_disconnect (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">long</span> rl = wlan_disconnect();</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;disconnect returned %ld\n&quot;</span>, rl);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_disconnect = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;disconnect&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# disconnect from AP&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_disconnect</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_disconnect</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_DISCONNECT */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_IPCONFIG - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">const</span> <span class="keywordtype">char</span> *</div>
<div class="line">ipv4AsText (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * ipaddr)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">char</span> buffer[16];</div>
<div class="line">  snprintf(buffer, <span class="keyword">sizeof</span>(buffer), <span class="stringliteral">&quot;%u.%u.%u.%u&quot;</span>, ipaddr[3], ipaddr[2], ipaddr[1], ipaddr[0]);</div>
<div class="line">  <span class="keywordflow">return</span> buffer;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_ipconfig (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  tNetappIpconfigRetArgs ipc;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * p;</div>
<div class="line"></div>
<div class="line">  memset(&amp;ipc, 0, <span class="keyword">sizeof</span>(ipc));</div>
<div class="line">  netapp_ipconfig(&amp;ipc);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;IP: %s\n&quot;</span>, ipv4AsText(ipc.aucIP));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;NM: %s\n&quot;</span>, ipv4AsText(ipc.aucSubnetMask));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;GW: %s\n&quot;</span>, ipv4AsText(ipc.aucDefaultGateway));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;DHCP: %s\n&quot;</span>, ipv4AsText(ipc.aucDHCPServer));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;DNS: %s\n&quot;</span>, ipv4AsText(ipc.aucDNSServer));</div>
<div class="line">  p = ipc.uaMacAddr;</div>
<div class="line">  <span class="comment">/* WTF?  A little-endian MAC address?  This may be because of a bug</span></div>
<div class="line"><span class="comment">   * fix in the host driver; the original version was completely</span></div>
<div class="line"><span class="comment">   * wrong. */</span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;MAC: %02x.%02x.%02x.%02x.%02x.%02x\n&quot;</span>,</div>
<div class="line">          p[5], p[4], p[3], p[2], p[1], p[0]);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;SSID: %s\n&quot;</span>, ipc.uaSSID);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_ipconfig = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;ipconfig&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# show IP parameters&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_ipconfig</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_ipconfig</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_IPCONFIG */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_CONNECT - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span>sWlanSecMap {</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> val;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * tag;</div>
<div class="line">} sWlanSecMap;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> sWlanSecMap wlanSecMap[] = {</div>
<div class="line">  { WLAN_SEC_UNSEC, <span class="stringliteral">&quot;unsec&quot;</span> },</div>
<div class="line">  { WLAN_SEC_WEP, <span class="stringliteral">&quot;wep&quot;</span> },</div>
<div class="line">  { WLAN_SEC_WPA, <span class="stringliteral">&quot;wpa&quot;</span> },</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="comment">/* WPA2 is not implemented.  Unit will transmit unsecured auth request */</span></div>
<div class="line">  { WLAN_SEC_WPA2, <span class="stringliteral">&quot;wpa2&quot;</span> },</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* 0 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>};</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> sWlanSecMap * <span class="keyword">const</span> wlanSecMap_end = wlanSecMap + <span class="keyword">sizeof</span>(wlanSecMap)/<span class="keyword">sizeof</span>(*wlanSecMap);</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> sWlanSecMap * wlanSecMapFromValue (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> val)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line">  <span class="keywordflow">for</span> (mp = wlanSecMap; mp &lt; wlanSecMap_end; ++mp) {</div>
<div class="line">    <span class="keywordflow">if</span> (mp-&gt;val == val) {</div>
<div class="line">      <span class="keywordflow">return</span> mp;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> sWlanSecMap * wlanSecMapFromTag (<span class="keyword">const</span> <span class="keywordtype">char</span> * tag)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line">  <span class="keywordflow">for</span> (mp = wlanSecMap; mp &lt; wlanSecMap_end; ++mp) {</div>
<div class="line">    <span class="keywordflow">if</span> (0 == strcmp(mp-&gt;tag, tag)) {</div>
<div class="line">      <span class="keywordflow">return</span> mp;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">sConnectParams connectParams;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_sectype (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> remaining = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">size_t</span> len;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * tp;</div>
<div class="line">  <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line"></div>
<div class="line">  tp = <a name="a6"></a><a class="code" href="group__grp__utility__cli__hci.html#gabcda3dd127008a5cdcc5f40cac4e9e68">xBSP430cliNextQToken</a>(&amp;argstr, &amp;remaining, &amp;len);</div>
<div class="line">  <span class="keywordflow">if</span> (0 &lt; len) {</div>
<div class="line">    mp = wlanSecMapFromTag(tp);</div>
<div class="line">    <span class="keywordflow">if</span> (0 != mp) {</div>
<div class="line">      connectParams.security_type = mp-&gt;val;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: Unrecognized sectype &#39;%s&#39;: valid are&quot;</span>, tp);</div>
<div class="line">      <span class="keywordflow">for</span> (mp = wlanSecMap; mp &lt; wlanSecMap_end; ++mp) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; %s&quot;</span>, mp-&gt;tag);</div>
<div class="line">      }</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  mp = wlanSecMapFromValue(connectParams.security_type);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP security type is %s (%u)\n&quot;</span>, (mp ? mp-&gt;tag : <span class="stringliteral">&quot;&lt;UNDEF&gt;&quot;</span>), connectParams.security_type);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_ssid (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> remaining = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">size_t</span> len;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * tp;</div>
<div class="line"></div>
<div class="line">  tp = <a class="code" href="group__grp__utility__cli__hci.html#gabcda3dd127008a5cdcc5f40cac4e9e68">xBSP430cliNextQToken</a>(&amp;argstr, &amp;remaining, &amp;len);</div>
<div class="line">  <span class="keywordflow">if</span> (0 &lt; len) {</div>
<div class="line">    memcpy(connectParams.ssid, tp, len);</div>
<div class="line">    connectParams.ssid[len] = 0;</div>
<div class="line">    connectParams.ssid_len = len;</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP SSID is %s (%u chars)\n&quot;</span>, connectParams.ssid, connectParams.ssid_len);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_passphrase (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> remaining = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">size_t</span> len;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * tp;</div>
<div class="line"></div>
<div class="line">  tp = <a class="code" href="group__grp__utility__cli__hci.html#gabcda3dd127008a5cdcc5f40cac4e9e68">xBSP430cliNextQToken</a>(&amp;argstr, &amp;remaining, &amp;len);</div>
<div class="line">  <span class="keywordflow">if</span> (0 &lt; len) {</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(connectParams.passphrase) &lt;= (len+1)) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: Passphrase too long (&gt; %u chars + EOS)\n&quot;</span>, <span class="keyword">sizeof</span>(connectParams.passphrase));</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      memcpy(connectParams.passphrase, tp, len);</div>
<div class="line">      connectParams.passphrase[len] = 0;</div>
<div class="line">      connectParams.passphrase_len = len;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP passphrase is &#39;%s&#39; (%u chars)\n&quot;</span>, connectParams.passphrase, connectParams.passphrase_len);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_connect (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">long</span> rl;</div>
<div class="line">  <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t[2];</div>
<div class="line"></div>
<div class="line">  mp = wlanSecMapFromValue(connectParams.security_type);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;connect to ssid &#39;%s&#39; by %s using &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">          connectParams.ssid, (mp ? mp-&gt;tag : <span class="stringliteral">&quot;&lt;UNDEF&gt;&quot;</span>),</div>
<div class="line">          connectParams.passphrase);</div>
<div class="line">  t[0] = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">  rl = wlan_connect(connectParams.security_type,</div>
<div class="line">                    connectParams.ssid, connectParams.ssid_len,</div>
<div class="line">                    NULL,</div>
<div class="line">                    connectParams.passphrase, connectParams.passphrase_len);</div>
<div class="line">  t[1] = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;con %ld in %s\n&quot;</span>, rl, <a class="code" href="uptime_8h.html#a790fc3c41c4a8e93ec7caca7825733c1">xBSP430uptimeAsText_ni</a>(t[1]-t[0]));</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_ssid = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;ssid&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[{ssid}] # Display or set AP SSID for connect&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_ssid</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_passphrase = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;passphrase&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[{passphrase}] # Display or set AP passphrase&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_ssid,</div>
<div class="line">  .<a name="a7"></a><a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_passphrase</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_sectype = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;sectype&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[{sectype}] # Display or set AP sectype&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_passphrase,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_sectype</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_connect = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;connect&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# connect to specified access point using AP config&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_sectype,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_connect</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_connect</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_CONNECT */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_STATUS - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_status (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">/* Contrary to the documentation, there are no macro constants</span></div>
<div class="line"><span class="comment">   * defined for these states */</span></div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * status_str[] = {</div>
<div class="line">    <span class="stringliteral">&quot;disconnected&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;scanning&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;connecting&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;connected&quot;</span></div>
<div class="line">  };</div>
<div class="line">  <span class="keywordtype">long</span> rl = wlan_ioctl_statusget();</div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_CONNECT - 0</span></div>
<div class="line"><span class="preprocessor"></span>  {</div>
<div class="line">    <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line">    mp = wlanSecMapFromValue(connectParams.security_type);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP configuration SSID &#39;%s&#39;, passphrase &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">            connectParams.ssid, connectParams.passphrase);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP security type %s (%u)\n&quot;</span>, (mp ? mp-&gt;tag : <span class="stringliteral">&quot;&lt;UNDEF&gt;&quot;</span>), connectParams.security_type);</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_CONNECT */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;WLAN status %ld&quot;</span>, rl);</div>
<div class="line">  <span class="keywordflow">if</span> ((0 &lt;= rl) &amp;&amp; (rl &lt; (<span class="keyword">sizeof</span>(status_str)/<span class="keyword">sizeof</span>(*status_str)))) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;: %s&quot;</span>, status_str[rl]);</div>
<div class="line">  }</div>
<div class="line">  <a name="a8"></a><a class="code" href="console_8h.html#a90f7ebaff29b80e288b6890ed9201f2c">cputchar</a>(<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_status = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;status&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# get CC3000 status and AP config&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_status</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_status</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_STATUS */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_START - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_start (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t[2];</div>
<div class="line">  t[0] = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">  wlan_start(0);</div>
<div class="line">  t[1] = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;wlan_start() took %s\n&quot;</span>, <a class="code" href="uptime_8h.html#a790fc3c41c4a8e93ec7caca7825733c1">xBSP430uptimeAsText_ni</a>(t[1]-t[0]));</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_start = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;start&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# power-up CC3000&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_start</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_start</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_START */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;wlan&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .child = LAST_SUB_COMMAND</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_wlan</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND NULL</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (CMD_NVMEM - 0) &amp;&amp; (CMD_NVMEM_SP - 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_nvmem_sp (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> patch_version[2];</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> rv;</div>
<div class="line"></div>
<div class="line">  memset(patch_version, -1, <span class="keyword">sizeof</span>(patch_version));</div>
<div class="line">  rv = nvmem_read_sp_version(patch_version);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;sp ret %u: %u.%u\n&quot;</span>, rv, patch_version[0], patch_version[1]);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem_sp = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;sp&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# read firmware service pack level&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_nvmem_sp</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_nvmem_sp</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_NVMEM_SP */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (CMD_NVMEM - 0) &amp;&amp; (CMD_NVMEM_READ - 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_nvmem_read (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fileid = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len = 128;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ofs = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> data[32];</div>
<div class="line">  <span class="keywordtype">char</span> asciiz[17];</div>
<div class="line">  <span class="keywordtype">char</span> * ap;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> end_read;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ui;</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nb;</div>
<div class="line"></div>
<div class="line">  rc = <a name="a9"></a><a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;ui);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    fileid = ui;</div>
<div class="line">    rc = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;ui);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    len = ui;</div>
<div class="line">    rc = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;ui);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    ofs = ui;</div>
<div class="line">  }</div>
<div class="line">  end_read = ofs + len;</div>
<div class="line">  memset(asciiz, 0, <span class="keyword">sizeof</span>(asciiz));</div>
<div class="line">  ap = asciiz;</div>
<div class="line">  rc = 0;</div>
<div class="line">  <span class="keywordflow">while</span> ((0 == rc) &amp;&amp; (ofs &lt; end_read)) {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * dp;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * dpe;</div>
<div class="line">    nb = (end_read - ofs);</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(data) &lt; nb) {</div>
<div class="line">      nb = <span class="keyword">sizeof</span>(data);</div>
<div class="line">    }</div>
<div class="line">    rc = nvmem_read(fileid, nb, ofs, data);</div>
<div class="line">    <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">      dp = data;</div>
<div class="line">      dpe = dp + nb;</div>
<div class="line">      <span class="keywordflow">while</span> (dp &lt; dpe) {</div>
<div class="line">        <span class="keywordflow">if</span> (0 == (ofs % 16)) {</div>
<div class="line">          <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;    %s\n%x.%04x &quot;</span>, asciiz, fileid, ofs);</div>
<div class="line">          memset(asciiz, 0, <span class="keyword">sizeof</span>(asciiz));</div>
<div class="line">          ap = asciiz;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == (ofs % 8)) {</div>
<div class="line">          <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; &quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        ++ofs;</div>
<div class="line">        *ap++ = isprint(*dp) ? *dp : <span class="charliteral">&#39;.&#39;</span>;</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; %02x&quot;</span>, *dp++);</div>
<div class="line">      }</div>
<div class="line">      len -= nb;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;    %s\n&quot;</span>, asciiz);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\nERR: Read returned %u for %u bytes at %u of fileid %u\n&quot;</span>,</div>
<div class="line">            rc, nb, ofs, fileid);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem_read = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;read&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;fileid [len(=128) [ofs(=0)]] # read block from nvmem file&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_nvmem_read</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_nvmem_read</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_NVMEM_READ */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (CMD_NVMEM - 0) &amp;&amp; (CMD_NVMEM_MAC - 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_nvmem_mac (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> mac[6];</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Could extend this to parse &quot;set {addr}&quot; if you wanted. */</span></div>
<div class="line">  rc = nvmem_get_mac_address(mac);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;nvmem mac is %02x.%02x.%02x.%02x.%02x.%02x\n&quot;</span>,</div>
<div class="line">            mac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: nvmem mac read got %u\n&quot;</span>, rc);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem_mac = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;mac&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# get mac address&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_nvmem_mac</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_nvmem_mac</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_NVMEM_MAC */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (CMD_NVMEM - 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;nvmem&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .child = LAST_SUB_COMMAND</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_nvmem</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND NULL</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_NVMEM */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if ! (BSP430_MODULE_FLASH - 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="comment">/* No support for this on FRAM boards yet */</span></div>
<div class="line"><span class="preprocessor">#undef CMD_INFO</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_INFO - 0</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> sConnectParams * <span class="keyword">const</span> infoConnectParams = (sConnectParams *)__infob;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_info_load (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (MAGIC_CONNECT_PARAMS != infoConnectParams-&gt;magic) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: Stored connection params invalid\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN_CONNECT - 0)</span></div>
<div class="line"><span class="preprocessor"></span>  connectParams = *infoConnectParams;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_CONNECT */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_info_erase_ni (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Erasing stored params at %p...&quot;</span>, infoConnectParams);</div>
<div class="line">  rv = <a name="a10"></a><a class="code" href="flash_8h.html#a94c76cef12d30a8fb476cb7664338285">iBSP430flashEraseSegment_ni</a>(infoConnectParams);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%d\n&quot;</span>, rv);</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_info_erase (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  <a name="a11"></a><a class="code" href="core_8h.html#a15976e4890ec6eacf5cbddf25c5b11c7">BSP430_CORE_INTERRUPT_STATE_T</a> istate;</div>
<div class="line"></div>
<div class="line">  <a name="a12"></a><a class="code" href="core_8h.html#ae4bfa3ada65bbdf28947828ce7966ec1">BSP430_CORE_SAVE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <a name="a13"></a><a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    rv = cmd_info_erase_ni();</div>
<div class="line">  } <span class="keywordflow">while</span> (0);</div>
<div class="line">  <a name="a14"></a><a class="code" href="core_8h.html#a5e9ec46fa426727b23b14cd505e5bbec">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_info_store (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#a15976e4890ec6eacf5cbddf25c5b11c7">BSP430_CORE_INTERRUPT_STATE_T</a> istate;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ae4bfa3ada65bbdf28947828ce7966ec1">BSP430_CORE_SAVE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    rv = cmd_info_erase_ni();</div>
<div class="line">    <span class="keywordflow">if</span> (0 == rv) {</div>
<div class="line">      connectParams.magic = MAGIC_CONNECT_PARAMS;</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Copying current configuration...&quot;</span>);</div>
<div class="line">      rv = <a name="a15"></a><a class="code" href="flash_8h.html#ae8561ad078b62fd3ceadabbe69421d5a">iBSP430flashWriteData_ni</a>(infoConnectParams, &amp;connectParams, <span class="keyword">sizeof</span>(connectParams));</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%d\n&quot;</span>, rv);</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">while</span> (0);</div>
<div class="line">  <a class="code" href="core_8h.html#a5e9ec46fa426727b23b14cd505e5bbec">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_info_store = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;store&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# store wlan AP params in INFO_B&quot;</span>),</div>
<div class="line">  .next = NULL,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_info_store</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_info_erase = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;erase&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# erase INFO_B&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_info_store,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_info_erase</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_info_load = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;load&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# load wlan AP params from INFO_B&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_info_erase,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_info_load</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_info = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;info&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .child = &amp;dcmd_info_load</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_info</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_INFO */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (CMD_HELP - 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_help (<a name="_a16"></a><a class="code" href="structsBSP430cliCommandLink.html">sBSP430cliCommandLink</a> * chain,</div>
<div class="line">          <span class="keywordtype">void</span> * param,</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">char</span> * command,</div>
<div class="line">          <span class="keywordtype">size_t</span> command_len)</div>
<div class="line">{</div>
<div class="line">  <a name="a17"></a><a class="code" href="group__grp__utility__cli__cli.html#ga2c3a36a00ea6f676cf2006859364d45a">vBSP430cliConsoleDisplayHelp</a>(chain-&gt;<a name="a18"></a><a class="code" href="structsBSP430cliCommandLink.html#a1abd6b2e5174e42795a7c73191732520">cmd</a>);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_help = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;help&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = cmd_help</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_help</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_HELP */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keywordtype">void</span> main (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * command;</div>
<div class="line">  <span class="keywordtype">int</span> flags;</div>
<div class="line"><span class="preprocessor">#if BSP430_MODULE_SYS - 0</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> reset_causes = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> reset_flags = 0;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_MODULE_SYS */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if BSP430_MODULE_SYS - 0</span></div>
<div class="line"><span class="preprocessor"></span>  {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sysrstiv;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Record all the reset causes */</span></div>
<div class="line">    <span class="keywordflow">while</span> (0 != ((sysrstiv = <a name="a19"></a><a class="code" href="sys_8h.html#a49bc446977f788990eaf4de3e3b3d234">uiBSP430sysSYSRSTGenerator_ni</a>(&amp;reset_flags)))) {</div>
<div class="line">      reset_causes |= 1UL &lt;&lt; (sysrstiv / 2);</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#ifdef BSP430_PMM_ENTER_LPMXp5_NI</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="comment">/* If we woke from LPMx.5, we need to clear the lock in PM5CTL0.</span></div>
<div class="line"><span class="comment">     * We&#39;ll do it early, since we&#39;re not really interested in</span></div>
<div class="line"><span class="comment">     * retaining the current IFG settings. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; <a name="a20"></a><a class="code" href="sys_8h.html#ae4f97a3ceec5eb5a0c3d5f523a1f303a">BSP430_SYS_FLAG_SYSRST_LPM5WU</a>) {</div>
<div class="line">      PMMCTL0_H = PMMPW_H;</div>
<div class="line">      PM5CTL0 = 0;</div>
<div class="line">      PMMCTL0_H = 0;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PMM_ENTER_LPMXp5_NI */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>  }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_MODULE_SYS */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">  <a name="a21"></a><a class="code" href="platform_8h.html#a616515ce5e0f7635ca36a815841d2a21">vBSP430platformInitialize_ni</a>();</div>
<div class="line">  (void)<a name="a22"></a><a class="code" href="console_8h.html#a91f5f68fa2ee29ca39bf9a23ea98cbe1">iBSP430consoleInitialize</a>();</div>
<div class="line">  <a name="a23"></a><a class="code" href="cli_8h.html#a0a5b3cee7e2d9002d5d301b36c814d55">vBSP430cliSetDiagnosticFunction</a>(<a name="a24"></a><a class="code" href="group__grp__utility__cli__cli.html#ga30922f40d6b2702628bb88d9e0069caf">iBSP430cliConsoleDiagnostic</a>);</div>
<div class="line">  <a name="a25"></a><a class="code" href="core_8h.html#a327cb5d1a1607c19c9551a18507bbb63">BSP430_CORE_DELAY_CYCLES</a>(<a name="a26"></a><a class="code" href="clock_8h.html#a6ffd3f4fab35b64d0e8ff8d3179d69d9">BSP430_CLOCK_NOMINAL_MCLK_HZ</a> / 2);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\ncc3000 &quot;</span> __DATE__ <span class="stringliteral">&quot; &quot;</span> __TIME__ <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if BSP430_MODULE_SYS - 0</span></div>
<div class="line"><span class="preprocessor"></span>  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;System reset bitmask %lx; causes:\n&quot;</span>, reset_causes);</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">int</span> bit = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (bit &lt; (8 * <span class="keyword">sizeof</span>(reset_causes))) {</div>
<div class="line">      <span class="keywordflow">if</span> (reset_causes &amp; (1UL &lt;&lt; bit)) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\t%s\n&quot;</span>, <a name="a27"></a><a class="code" href="sys_8h.html#a2012d634fbc0045a010a2158b37248f2">xBSP430sysSYSRSTIVDescription</a>(2*bit));</div>
<div class="line">      }</div>
<div class="line">      ++bit;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a name="a28"></a><a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot;System reset included:&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (reset_flags) {</div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; <a name="a29"></a><a class="code" href="sys_8h.html#a790d901e62558a64459412e0459d8d7a">BSP430_SYS_FLAG_SYSRST_BOR</a>) {</div>
<div class="line">      <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; BOR&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; <a class="code" href="sys_8h.html#ae4f97a3ceec5eb5a0c3d5f523a1f303a">BSP430_SYS_FLAG_SYSRST_LPM5WU</a>) {</div>
<div class="line">      <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; LPM5WU&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; <a name="a30"></a><a class="code" href="sys_8h.html#ad8a250b767d995a059bcf3b2d2af5d12">BSP430_SYS_FLAG_SYSRST_POR</a>) {</div>
<div class="line">      <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; POR&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; <a name="a31"></a><a class="code" href="sys_8h.html#a43c4718bdc338c7f4bcfc66726b3fe86">BSP430_SYS_FLAG_SYSRST_PUC</a>) {</div>
<div class="line">      <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; PUC&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; no data&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <a name="a32"></a><a class="code" href="console_8h.html#a46ea793d7dd79b66e1c3a195d0d4a7b1">cputchar_ni</a>(<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_MODULE_SYS */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (BSP430_MODULE_PMM - 0) &amp;&amp; ! (BSP430_MODULE_PMM_FRAM - 0)</span></div>
<div class="line"><span class="preprocessor"></span>  rv = <a name="a33"></a><a class="code" href="pmm_8h.html#ac3621d45ad0e516384a5dce097dadba9">iBSP430pmmSetCoreVoltageLevel_ni</a>(<a name="a34"></a><a class="code" href="msp430_8h.html#a4aa3f2a0135a48433168c58a596e88da">PMMCOREV_3</a>);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Vcore at %d\n&quot;</span>, rv);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;PWR_EN at %s.%u\n&quot;</span>, <a name="a35"></a><a class="code" href="port_8h.html#a78a791b05b428f3aa2bf5ff09e907200">xBSP430portName</a>(<a name="a36"></a><a class="code" href="rfem_8h.html#a8ef1d1dc188b30379f946635a3920f07">BSP430_RFEM_PWR_EN_PORT_PERIPH_HANDLE</a>), <a name="a37"></a><a class="code" href="port_8h.html#aa9b72a778f0f690c08bba27871c4d374">iBSP430portBitPosition</a>(<a name="a38"></a><a class="code" href="rfem_8h.html#a02b8877017074eff5126882bdee9f840">BSP430_RFEM_PWR_EN_PORT_BIT</a>));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;SPI_IRQ HAL at %s.%u\n&quot;</span>, <a class="code" href="port_8h.html#a78a791b05b428f3aa2bf5ff09e907200">xBSP430portName</a>(<a name="a39"></a><a class="code" href="rfem_8h.html#a526c15df0b78d0e456a1d8777a47ec43">BSP430_RFEM_SPI_IRQ_PORT_PERIPH_HANDLE</a>), <a class="code" href="port_8h.html#aa9b72a778f0f690c08bba27871c4d374">iBSP430portBitPosition</a>(<a name="a40"></a><a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;CSn HAL at %s.%u\n&quot;</span>, <a class="code" href="port_8h.html#a78a791b05b428f3aa2bf5ff09e907200">xBSP430portName</a>(<a name="a41"></a><a class="code" href="rfem_8h.html#af2db206437914504f599c7edd1aa6443">BSP430_RFEM_SPI0CSn_PORT_PERIPH_HANDLE</a>), <a class="code" href="port_8h.html#aa9b72a778f0f690c08bba27871c4d374">iBSP430portBitPosition</a>(<a name="a42"></a><a class="code" href="rfem_8h.html#ac34b2d6647910584c94c65e19cae23f4">BSP430_RFEM_SPI0CSn_PORT_BIT</a>));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;SPI is %s\n&quot;</span>, <a name="a43"></a><a class="code" href="serial_8h.html#a7f2e6f39abd1faca343663917e34840a">xBSP430serialName</a>(<a name="a44"></a><a class="code" href="rfem_8h.html#a591494d7035a46d6f8e7d47151378b84">BSP430_RFEM_SPI0_PERIPH_HANDLE</a>));</div>
<div class="line"><span class="preprocessor">#if BSP430_PLATFORM_PERIPHERAL_HELP</span></div>
<div class="line"><span class="preprocessor"></span>  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;SPI Pins: %s\n&quot;</span>, <a name="a45"></a><a class="code" href="platform_8h.html#ad5df0a450196592bc395c5efe89a6fb3">xBSP430platformPeripheralHelp</a>(<a class="code" href="rfem_8h.html#a591494d7035a46d6f8e7d47151378b84">BSP430_RFEM_SPI0_PERIPH_HANDLE</a>, <a name="a46"></a><a class="code" href="periph_8h.html#a5a28880814f93f755ea189df4e2d1900">BSP430_PERIPHCFG_SERIAL_SPI3</a>));</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PLATFORM_PERIPHERAL_HELP */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(__DATE__ <span class="stringliteral">&quot; &quot;</span> __TIME__ <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Initialization can be done with interrupts disabled, since the</span></div>
<div class="line"><span class="comment">   * function does nothing but store callbacks. */</span></div>
<div class="line">  rv = <a name="a47"></a><a class="code" href="cc3000spi_8h.html#a18c48988f94c6984548d28e802377344">iBSP430cc3000spiInitialize</a>(wlan_cb, NULL, NULL, NULL);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%s Initialize returned %d\n&quot;</span>, <a class="code" href="uptime_8h.html#a790fc3c41c4a8e93ec7caca7825733c1">xBSP430uptimeAsText_ni</a>(<a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>()), rv);</div>
<div class="line"></div>
<div class="line">  commandSet = LAST_COMMAND;</div>
<div class="line">  command = NULL;</div>
<div class="line">  flags = <a name="a48"></a><a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deaf4a31c8e1956488e1ff37d22d55936b3">eBSP430cliConsole_REPAINT</a>;</div>
<div class="line"></div>
<div class="line">  <a name="a49"></a><a class="code" href="core_8h.html#a954f39fe5652611f5a20f74289b0cfbf">BSP430_CORE_ENABLE_INTERRUPT</a>();</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* wlan_start() MUST be invoked with interrupts enabled. */</span></div>
<div class="line">  wlan_start(0);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\nAnd wlan has been started.\n&quot;</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if CMD_INFO - 0</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (0 == cmd_info_load(<span class="stringliteral">&quot;&quot;</span>)) {</div>
<div class="line">    cmd_wlan_status(<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">  <span class="keywordflow">while</span> (1) {</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; <a name="a50"></a><a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deafdfdebe7b8568728238e4069ae19cd09">eBSP430cliConsole_DO_COMPLETION</a>) {</div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_DO_COMPLETION;</div>
<div class="line">      flags |= <a name="a51"></a><a class="code" href="group__grp__utility__cli__completion.html#ga5086d946e412fa4e9928819d664fc2cc">iBSP430cliConsoleBufferCompletion</a>(commandSet, &amp;command);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; <a name="a52"></a><a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69dea09d4c7792c3db363181260eebd086d94">eBSP430cliConsole_READY</a>) {</div>
<div class="line">      <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">      rv = <a name="a53"></a><a class="code" href="cli_8h.html#adcdb159a40c5cb6737cf97b497b58a55">iBSP430cliExecuteCommand</a>(commandSet, 0, command);</div>
<div class="line">      <span class="keywordflow">if</span> (0 != rv) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Command execution returned %d\n&quot;</span>, rv);</div>
<div class="line">      }</div>
<div class="line">      <span class="comment">/* Ensure prompt is rewritten, but not the command we just</span></div>
<div class="line"><span class="comment">       * ran */</span></div>
<div class="line">      flags |= <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deaf4a31c8e1956488e1ff37d22d55936b3">eBSP430cliConsole_REPAINT</a>;</div>
<div class="line">      command = NULL;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deaf4a31c8e1956488e1ff37d22d55936b3">eBSP430cliConsole_REPAINT</a>) {</div>
<div class="line">      <span class="comment">/* Draw the prompt along with whatever&#39;s left in the command buffer */</span></div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;&gt; %s&quot;</span>, command ? command : <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_REPAINT;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; <a name="a54"></a><a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69dea1af184228ab718533ff1ef6a1b4f5a8b">eBSP430cliConsole_REPAINT_BEL</a>) {</div>
<div class="line">      <a class="code" href="console_8h.html#a90f7ebaff29b80e288b6890ed9201f2c">cputchar</a>(<span class="charliteral">&#39;\a&#39;</span>);</div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_REPAINT_BEL;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; eBSP430cliConsole_READY) {</div>
<div class="line">      <span class="comment">/* Clear the command we just completed */</span></div>
<div class="line">      <a name="a55"></a><a class="code" href="group__grp__utility__cli__cli.html#ga851a3ff12f32fc07f0e83b084dbd659d">vBSP430cliConsoleBufferClear_ni</a>();</div>
<div class="line">    }</div>
<div class="line">    flags = <a name="a56"></a><a class="code" href="group__grp__utility__cli__cli.html#ga0dc701d6a0e8678616dbdc43219f2628">iBSP430cliConsoleBufferProcessInput_ni</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (flags) {</div>
<div class="line">      <span class="comment">/* Got something to do; get the command contents in place */</span></div>
<div class="line">      command = <a name="a57"></a><a class="code" href="group__grp__utility__cli__cli.html#gad0d2c92b96b17302159c049f7a9bfb17">xBSP430cliConsoleBuffer_ni</a>();</div>
<div class="line">      <a class="code" href="core_8h.html#a954f39fe5652611f5a20f74289b0cfbf">BSP430_CORE_ENABLE_INTERRUPT</a>();</div>
<div class="line">      <span class="keywordflow">continue</span>;</div>
<div class="line">    }</div>
<div class="line">    <a name="a58"></a><a class="code" href="core_8h.html#ab3ba0bc9be345eb561a58747da602704">BSP430_CORE_LPM_ENTER_NI</a>(<a name="a59"></a><a class="code" href="msp430_8h.html#a8af1e5b3633693d9439d284100183004">LPM2_bits</a>);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Apr 27 2013 18:46:22 for BSP430 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.2
</small></address>
</body>
</html>
