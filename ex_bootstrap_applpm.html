<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>BSP430: Bootstrapping a New Platform: Application LPM</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BSP430
   &#160;<span id="projectnumber">20121002</span>
   </div>
   <div id="projectbrief">Board Support Package for MSP430 microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Bootstrapping a New Platform: Application LPM </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This program gives an example of using LPM within an application, where there are timers, serial peripherals, and other things that need to be disabled and enabled around the low power transition.</p>
<h1><a class="anchor" id="Per"></a>
Platform Results</h1>
<p>Measurements using this application for different platforms and different configurations are below. The power values are in microamps; the boards were powered by USB at 3.6V. In the first column (+S, +U) the USCI serial and Timer_A-based uptime clock are left enabled. In the second (-S, +U), the USCI serial is placed in reset mode prior to entering LPM. In the third (-S, -U) the uptime clock is also placed in reset mode.</p>
<p>Some platforms support LPMx.5 modes, which are very low power and require something like the <a href="http://www.eevblog.com/projects/ucurrent/">EEVblog uCurrent</a> to measure. LPM3 and LPM4 for the MSP430G2553 is also sub-100nA and cannot be measured with a standard ammeter.</p>
<dl class="section note"><dt>Note</dt><dd>I am not an electrical engineer, so cannot explain any anomalies in the measurements below. But they check out as consistent using different ammeters and are within range of the datasheet values, so I call them plausible.</dd></dl>
<h2><a class="anchor" id="EXP430G2"></a>
EXP430G2</h2>
<p>Use a revision 1.5 board; earlier ones do poorly. Place the ammeter across the Vcc pair on the header connecting the emulation and MSP430 sides of the board.</p>
<table class="doxtable">
<tr>
<th align="right">uA (+S,+U) </th><th align="right">uA (-S,+U) </th><th align="right">uA (-S,-U) </th><th>Description</th></tr>
<tr>
<td align="right">386 </td><td align="right">385 </td><td align="right">385 </td><td>active mode with CPU running (reading USCI) </td></tr>
<tr>
<td align="right">396 </td><td align="right">396 </td><td align="right">396 </td><td>in active mode "idle" </td></tr>
<tr>
<td align="right">77.1 </td><td align="right">77.0 </td><td align="right">76.8 </td><td>LPM0 </td></tr>
<tr>
<td align="right">77.1 </td><td align="right">77.1 </td><td align="right">76.8 </td><td>LPM1 </td></tr>
<tr>
<td align="right">23.1 </td><td align="right">23.1 </td><td align="right">22.9 </td><td>LPM2 </td></tr>
<tr>
<td align="right">0.40 </td><td align="right">0.550 </td><td align="right">0.393 </td><td>LPM3 </td></tr>
<tr>
<td align="right">0.098 </td><td align="right">0.062 </td><td align="right">0.060 </td><td>LPM4 </td></tr>
</table>
<p>Current costs are slightly higher in LPM3 and LPM4 if the crystal is populated.</p>
<h2><a class="anchor" id="EXP430FR5739"></a>
EXP430FR5739</h2>
<p>Place the ammeter on the <code>MSP PWR</code> test header. Note that this board's lowest MCLK rate is 5.3MHz, unlike the others which are configured to run at 1MHz for this test. Since active-mode power consumption is proportional to MCLK rate, this may explain why the power consumption in active mode is relatively high.</p>
<table class="doxtable">
<tr>
<th align="right">uA (+S,+U) </th><th align="right">uA (-S,+U) </th><th align="right">uA (-S,-U) </th><th>Description</th></tr>
<tr>
<td align="right">649 </td><td align="right">650 </td><td align="right">650 </td><td>active mode with CPU running (reading USCI) </td></tr>
<tr>
<td align="right">431 </td><td align="right">425 </td><td align="right">425 </td><td>in active mode "idle" </td></tr>
<tr>
<td align="right">167 </td><td align="right">176 </td><td align="right">176 </td><td>LPM0 </td></tr>
<tr>
<td align="right">166 </td><td align="right">124 </td><td align="right">123 </td><td>LPM1 </td></tr>
<tr>
<td align="right">140 </td><td align="right">64 </td><td align="right">63.6 </td><td>LPM2 </td></tr>
<tr>
<td align="right">136 </td><td align="right">5.8 </td><td align="right">5.8 </td><td>LPM3 </td></tr>
<tr>
<td align="right">137 </td><td align="right">5.8 </td><td align="right">5.8 </td><td>LPM4 </td></tr>
<tr>
<td align="right">0.254 </td><td align="right">0.290 </td><td align="right">0.290 </td><td>LPM3.5 </td></tr>
<tr>
<td align="right">0.254 </td><td align="right">0.290 </td><td align="right">0.290 </td><td>LPM4.5 </td></tr>
</table>
<p>I don't know why it's lower power to keep USCI and Timer_A enabled in LPMx.5. That's just what the measurements show.</p>
<h2><a class="anchor" id="EXP430F5438"></a>
EXP430F5438</h2>
<p>Place the ammeter on the <code>430 PWR</code> test header.</p>
<table class="doxtable">
<tr>
<th align="right">uA (+S,+U) </th><th align="right">uA (-S,+U) </th><th align="right">uA (-S,-U) </th><th>Description</th></tr>
<tr>
<td align="right">283 </td><td align="right">282 </td><td align="right">281 </td><td>active mode with CPU running (reading USCI) </td></tr>
<tr>
<td align="right">288 </td><td align="right">290 </td><td align="right">289 </td><td>in active mode "idle" </td></tr>
<tr>
<td align="right">81.4 </td><td align="right">83 </td><td align="right">82 </td><td>LPM0 </td></tr>
<tr>
<td align="right">80.4 </td><td align="right">81.7 </td><td align="right">82 </td><td>LPM1 </td></tr>
<tr>
<td align="right">6.9 </td><td align="right">8.9 </td><td align="right">8.8 </td><td>LPM2 </td></tr>
<tr>
<td align="right">2.4 </td><td align="right">4.4 </td><td align="right">4.2 </td><td>LPM3 </td></tr>
<tr>
<td align="right">2.4 </td><td align="right">4.4 </td><td align="right">1.0 </td><td>LPM4 </td></tr>
<tr>
<td align="right">2.4 </td><td align="right">4.4 </td><td align="right">4.2 </td><td>LPM3.5 </td></tr>
<tr>
<td align="right">2.4 </td><td align="right">4.4 </td><td align="right">0.051 </td><td>LPM4.5 </td></tr>
</table>
<p>Note that LPM3.5 doesn't seem to be different from LPM3, and unlike the FR5739 LPM4.5 is not entered if either the serial or the timer are left enabled.</p>
<h1><a class="anchor" id="ex_bootstrap_applpm_main"></a>
main.c</h1>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="platform_8h.html" title="Entrypoint for platform-specific capabilities.">bsp430/platform.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="clock_8h.html" title="Clock-related functions implemented on all MSP430 MCUs.">bsp430/clock.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="lpm_8h.html" title="Support for low power mode execution.">bsp430/lpm.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="led_8h.html" title="Support for platform-independent LED manipulation.">bsp430/utility/led.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="uptime_8h.html" title="Support for maintaining a system uptime counter.">bsp430/utility/uptime.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="console_8h.html" title="A generic console print capability.">bsp430/utility/console.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="port_8h.html" title="Hardware presentation/abstraction for Digital I/O Port (PORT#/PORT#_R)">bsp430/periph/port.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="pmm_8h.html" title="Hardware presentation/abstraction for Power Management Module (PMM).">bsp430/periph/pmm.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sys_8h.html" title="Hardware presentation/abstraction for SYS peripheral (SYS).">bsp430/periph/sys.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if ! (BSP430_PLATFORM_BUTTON0 - 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#error No button available on this platform</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PLATFORM_BUTTON0 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Core voltage control is supported on 5xx/6xx modules with PMM</span></div>
<div class="line"><span class="comment"> * support but not on FRAM devices. */</span></div>
<div class="line"><span class="preprocessor">#define APP_ENABLE_COREV (BSP430_MODULE_PMM - 0) &amp;&amp; ! (BSP430_MODULE_PMM_FRAM - 0)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>sCommand {</div>
<div class="line">  <span class="keywordtype">char</span> cmd;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * description;</div>
<div class="line">} sCommand;</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> sCommand commands[] = {</div>
<div class="line"><span class="preprocessor">#define CMD_MODE_ACTIVE &#39;a&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_MODE_ACTIVE, <span class="stringliteral">&quot;Remain in active mode while idle&quot;</span> },</div>
<div class="line"><span class="preprocessor">#define CMD_MODE_LPM0 &#39;0&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_MODE_LPM0, <span class="stringliteral">&quot;Set mode to enter LPM0&quot;</span> },</div>
<div class="line"><span class="preprocessor">#define CMD_MODE_LPM1 &#39;1&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_MODE_LPM1, <span class="stringliteral">&quot;Set mode to enter LPM1&quot;</span> },</div>
<div class="line"><span class="preprocessor">#define CMD_MODE_LPM2 &#39;2&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_MODE_LPM2, <span class="stringliteral">&quot;Set mode to enter LPM2&quot;</span> },</div>
<div class="line"><span class="preprocessor">#define CMD_MODE_LPM3 &#39;3&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_MODE_LPM3, <span class="stringliteral">&quot;Set mode to enter LPM3&quot;</span> },</div>
<div class="line"><span class="preprocessor">#define CMD_MODE_LPM4 &#39;4&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_MODE_LPM4, <span class="stringliteral">&quot;Set mode to enter LPM4&quot;</span> },</div>
<div class="line"><span class="preprocessor">#ifdef BSP430_PMM_ENTER_LPMXp5_NI</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_MODE_LPM3p5 &#39;5&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_MODE_LPM3p5, <span class="stringliteral">&quot;Set mode to enter LPM3.5&quot;</span> },</div>
<div class="line"><span class="preprocessor">#define CMD_MODE_LPM4p5 &#39;6&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_MODE_LPM4p5, <span class="stringliteral">&quot;Set mode to enter LPM4.5&quot;</span> },</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PMM_ENTER_LPMXp5_NI */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_HOLD_SERIAL &#39;s&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_HOLD_SERIAL, <span class="stringliteral">&quot;Toggle whether serial is placed on hold during LPM&quot;</span> },</div>
<div class="line"><span class="preprocessor">#define CMD_HOLD_CLOCK &#39;u&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_HOLD_CLOCK, <span class="stringliteral">&quot;Toggle whether uptime clock is placed on hold during LPM&quot;</span> },</div>
<div class="line"><span class="preprocessor">#define CMD_HELP &#39;?&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_HELP, <span class="stringliteral">&quot;Display help&quot;</span> },</div>
<div class="line"><span class="preprocessor">#define CMD_STATE &#39;=&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_STATE, <span class="stringliteral">&quot;Display system state (clock speeds, etc.)&quot;</span> },</div>
<div class="line"><span class="preprocessor">#define CMD_SLEEP &#39;$&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_SLEEP, <span class="stringliteral">&quot;Enter sleep mode&quot;</span> },</div>
<div class="line"><span class="preprocessor">#if APP_ENABLE_COREV</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_COREV_INCR &#39;&gt;&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_COREV_INCR, <span class="stringliteral">&quot;Increment core voltage&quot;</span> },</div>
<div class="line"><span class="preprocessor">#define CMD_COREV_DECR &#39;&lt;&#39;</span></div>
<div class="line"><span class="preprocessor"></span>  { CMD_COREV_DECR, <span class="stringliteral">&quot;Decrement core voltage&quot;</span> },</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* APP_ENABLE_COREV */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>};</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>sState {</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lpm_bits;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * lpm_description;</div>
<div class="line">  <span class="keywordtype">int</span> hold_serial;</div>
<div class="line">  <span class="keywordtype">int</span> hold_clock;</div>
<div class="line">} sState;</div>
<div class="line"></div>
<div class="line"><span class="keyword">volatile</span> <span class="keywordtype">int</span> button;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">button_isr_ni (<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsBSP430halISRIndexedChainNode.html">sBSP430halISRIndexedChainNode</a> * cb,</div>
<div class="line">               <span class="keywordtype">void</span> * context,</div>
<div class="line">               <span class="keywordtype">int</span> idx)</div>
<div class="line">{</div>
<div class="line">  (void)cb;</div>
<div class="line">  (void)context;</div>
<div class="line">  (void)idx;</div>
<div class="line">  ++button;</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="periph_8h.html#a94d022aee289b5f9350fbce9e6973078">BSP430_HAL_ISR_CALLBACK_DISABLE_INTERRUPT</a></div>
<div class="line">         | <a class="code" href="periph_8h.html#a0ff53da75572326697c26bef9dae0351">BSP430_HAL_ISR_CALLBACK_BREAK_CHAIN</a></div>
<div class="line">         | <a class="code" href="periph_8h.html#a54d508be960943682bb59a2d4e7225da">BSP430_HAL_ISR_CALLBACK_EXIT_LPM</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structsBSP430halISRIndexedChainNode.html">sBSP430halISRIndexedChainNode</a> button_cb = {</div>
<div class="line">  .<a class="code" href="structsBSP430halISRIndexedChainNode.html#ac76f42f3472c8e0e08dabbb50293452c">next_ni</a> = NULL,</div>
<div class="line">  .<a class="code" href="structsBSP430halISRIndexedChainNode.html#a88c6166d592b2f7720b89aac0d785c7a">callback</a> = button_isr_ni,</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">char</span> rx_buffer[16];</div>
<div class="line"><span class="keywordtype">char</span> * <span class="keyword">volatile</span> rx_head;</div>
<div class="line"><span class="keywordtype">char</span> * <span class="keyword">volatile</span> rx_tail;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">consume_rx_ni ()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (rx_head == rx_tail) {</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line">  rc = *rx_tail++;</div>
<div class="line">  <span class="keywordflow">if</span> (rx_tail &gt; (rx_buffer + <span class="keyword">sizeof</span>(rx_buffer) / <span class="keyword">sizeof</span>(*rx_buffer))) {</div>
<div class="line">    rx_tail = rx_buffer;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">consume_rx ()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line">  <a class="code" href="core_8h.html#a15976e4890ec6eacf5cbddf25c5b11c7">BSP430_CORE_INTERRUPT_STATE_T</a> istate;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ae4bfa3ada65bbdf28947828ce7966ec1">BSP430_CORE_SAVE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  rc = consume_rx_ni();</div>
<div class="line">  <a class="code" href="core_8h.html#a5e9ec46fa426727b23b14cd505e5bbec">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">rx_cbchain_ni (<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsBSP430halISRVoidChainNode.html">sBSP430halISRVoidChainNode</a> * cb,</div>
<div class="line">               <span class="keywordtype">void</span> * context)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="structsBSP430halSERIAL.html">hBSP430halSERIAL</a> device = (<a class="code" href="serial___8h.html#a31185ece51d6a343bb1f1c6f44fa8bcb">hBSP430halSERIAL</a>)context;</div>
<div class="line"></div>
<div class="line">  *rx_head++ = device-&gt;<a class="code" href="structsBSP430halSERIAL.html#a15e5570eb45ae458119bb23a3a346dfc">rx_byte</a>;</div>
<div class="line">  <span class="keywordflow">if</span> (rx_head &gt; (rx_buffer + <span class="keyword">sizeof</span>(rx_buffer) / <span class="keyword">sizeof</span>(*rx_buffer))) {</div>
<div class="line">    rx_head = rx_buffer;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (rx_head == rx_tail) {</div>
<div class="line">    (void)consume_rx_ni;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code" href="msp430_8h.html#a97eaedd508e6f77e34a49433f8e9e2eb">LPM4_bits</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span><a class="code" href="structsBSP430halISRVoidChainNode.html">sBSP430halISRVoidChainNode</a> rx_cb = {</div>
<div class="line">  .<a class="code" href="structsBSP430halISRVoidChainNode.html#a0d61bba3d225dcb3bb9611b0d4d69da2">callback</a> = rx_cbchain_ni</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> main ()</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="structsBSP430halPORT.html">hBSP430halPORT</a> b0hal;</div>
<div class="line">  <a class="code" href="structsBSP430halSERIAL.html">hBSP430halSERIAL</a> tty;</div>
<div class="line">  <span class="keyword">volatile</span> <a class="code" href="structsBSP430hplPORT__IE__8.html">sBSP430hplPORTIE</a> * b0hpl;</div>
<div class="line">  <span class="keywordtype">int</span> b0pin;</div>
<div class="line">  sState state;</div>
<div class="line"><span class="preprocessor">#if BSP430_MODULE_SYS - 0</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> reset_causes = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> reset_flags = 0;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_MODULE_SYS */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if BSP430_MODULE_SYS - 0</span></div>
<div class="line"><span class="preprocessor"></span>  {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sysrstiv;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Record all the reset causes */</span></div>
<div class="line">    <span class="keywordflow">while</span> (0 != ((sysrstiv = <a class="code" href="sys_8h.html#a49bc446977f788990eaf4de3e3b3d234">uiBSP430sysSYSRSTGenerator_ni</a>(&amp;reset_flags)))) {</div>
<div class="line">      reset_causes |= 1UL &lt;&lt; (sysrstiv / 2);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef BSP430_PMM_ENTER_LPMXp5_NI</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="comment">/* If we woke from LPMx.5, we need to clear the lock in PM5CTL0.</span></div>
<div class="line"><span class="comment">     * We&#39;ll do it early, since we&#39;re not really interested in</span></div>
<div class="line"><span class="comment">     * retaining the current IFG settings. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; <a class="code" href="sys_8h.html#ae4f97a3ceec5eb5a0c3d5f523a1f303a">BSP430_SYS_FLAG_SYSRST_LPM5WU</a>) {</div>
<div class="line">      PMMCTL0_H = PMMPW_H;</div>
<div class="line">      PM5CTL0 = 0;</div>
<div class="line">      PMMCTL0_H = 0;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PMM_ENTER_LPMXp5_NI */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>  }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_MODULE_SYS */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if APP_CONFIGURE_PORTS_FOR_LPM</span></div>
<div class="line"><span class="preprocessor"></span>  <a class="code" href="lpm_8h.html#ae15c7d81249ba5baff6f031a6612141b">vBSP430lpmConfigurePortsForLPM_ni</a>();</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* APP_CONFIGURE_PORTS_FOR_LPM */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>  <a class="code" href="platform_8h.html#a616515ce5e0f7635ca36a815841d2a21">vBSP430platformInitialize_ni</a>();</div>
<div class="line"></div>
<div class="line">  (void)<a class="code" href="console_8h.html#a91f5f68fa2ee29ca39bf9a23ea98cbe1">iBSP430consoleInitialize</a>();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Application is running\n&quot;</span>);</div>
<div class="line"><span class="preprocessor">#if BSP430_MODULE_SYS - 0</span></div>
<div class="line"><span class="preprocessor"></span>  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;System reset bitmask %lx; causes:\n&quot;</span>, reset_causes);</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">int</span> bit = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (bit &lt; (8 * <span class="keyword">sizeof</span>(reset_causes))) {</div>
<div class="line">      <span class="keywordflow">if</span> (reset_causes &amp; (1UL &lt;&lt; bit)) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\t%s\n&quot;</span>, <a class="code" href="sys_8h.html#a2012d634fbc0045a010a2158b37248f2">xBSP430sysSYSRSTIVDescription</a>(2*bit));</div>
<div class="line">      }</div>
<div class="line">      ++bit;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot;System reset included:&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (reset_flags &amp; <a class="code" href="sys_8h.html#a790d901e62558a64459412e0459d8d7a">BSP430_SYS_FLAG_SYSRST_BOR</a>) {</div>
<div class="line">    <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; BOR&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (reset_flags &amp; <a class="code" href="sys_8h.html#ae4f97a3ceec5eb5a0c3d5f523a1f303a">BSP430_SYS_FLAG_SYSRST_LPM5WU</a>) {</div>
<div class="line">    <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; LPM5WU&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (reset_flags &amp; <a class="code" href="sys_8h.html#ad8a250b767d995a059bcf3b2d2af5d12">BSP430_SYS_FLAG_SYSRST_POR</a>) {</div>
<div class="line">    <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; POR&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (reset_flags &amp; <a class="code" href="sys_8h.html#a43c4718bdc338c7f4bcfc66726b3fe86">BSP430_SYS_FLAG_SYSRST_PUC</a>) {</div>
<div class="line">    <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; PUC&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a46ea793d7dd79b66e1c3a195d0d4a7b1">cputchar_ni</a>(<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">  b0hal = <a class="code" href="port_8h.html#a039c56ddc64f51922244aac149f7a853">hBSP430portLookup</a>(<a class="code" href="platform_8h.html#a76fba1d2647ebe8bbd077521557efc39">BSP430_PLATFORM_BUTTON0_PORT_PERIPH_HANDLE</a>);</div>
<div class="line">  b0pin = <a class="code" href="port_8h.html#aa9b72a778f0f690c08bba27871c4d374">iBSP430portBitPosition</a>(<a class="code" href="platform_8h.html#a2d2bb16f09ab8d94f795e717a946a509">BSP430_PLATFORM_BUTTON0_PORT_BIT</a>);</div>
<div class="line">  b0hpl = <a class="code" href="port_8h.html#a3859a31c104fca29a2a3c00aa2e72e93">BSP430_PORT_HAL_GET_HPL_PORTIE</a>(b0hal);</div>
<div class="line">  b0hal-&gt;<a class="code" href="structsBSP430halPORT.html#a064ef3897a45a15efed3afe917517773">pin_cbchain_ni</a>[b0pin] = &amp;button_cb;</div>
<div class="line">  b0hpl-&gt;sel &amp;= ~<a class="code" href="platform_8h.html#a2d2bb16f09ab8d94f795e717a946a509">BSP430_PLATFORM_BUTTON0_PORT_BIT</a>;</div>
<div class="line">  b0hpl-&gt;dir &amp;= ~<a class="code" href="platform_8h.html#a2d2bb16f09ab8d94f795e717a946a509">BSP430_PLATFORM_BUTTON0_PORT_BIT</a>;</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if BSP430_PORT_SUPPORTS_REN - 0</span></div>
<div class="line"><span class="preprocessor"></span>  <a class="code" href="port_8h.html#a9addaf04ba38436b90d0dc9481c29425">BSP430_PORT_HAL_HPL_REN</a>(b0hal) |= <a class="code" href="platform_8h.html#a2d2bb16f09ab8d94f795e717a946a509">BSP430_PLATFORM_BUTTON0_PORT_BIT</a>;</div>
<div class="line">  <a class="code" href="port_8h.html#a4c6f6b6b83c5ffd5f8b6468065a8d209">BSP430_PORT_HAL_HPL_OUT</a>(b0hal) |= <a class="code" href="platform_8h.html#a2d2bb16f09ab8d94f795e717a946a509">BSP430_PLATFORM_BUTTON0_PORT_BIT</a>;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PORT_SUPPORTS_REN */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">  rx_head = rx_tail = rx_buffer;</div>
<div class="line">  <span class="comment">/* A careful coder would check to return values in the following */</span></div>
<div class="line">  tty = <a class="code" href="console_8h.html#a641b6419ca463bcb87d4ec1645928c0b">hBSP430console</a>();</div>
<div class="line">  (void)<a class="code" href="serial_8h.html#a4e6aa007adea01b8d1760fd3dc31b5e2">iBSP430serialSetHold_ni</a>(tty, 1);</div>
<div class="line">  rx_cb.<a class="code" href="structsBSP430halISRVoidChainNode.html#a8d30674994d901c6736d6ed933edc673">next_ni</a> = tty-&gt;<a class="code" href="structsBSP430halSERIAL.html#a47baad3d8dbbff41eff72a8bacd0ff33">rx_cbchain_ni</a>;</div>
<div class="line">  tty-&gt;<a class="code" href="structsBSP430halSERIAL.html#a47baad3d8dbbff41eff72a8bacd0ff33">rx_cbchain_ni</a> = &amp;rx_cb;</div>
<div class="line">  (void)<a class="code" href="serial_8h.html#a4e6aa007adea01b8d1760fd3dc31b5e2">iBSP430serialSetHold_ni</a>(tty, 0);</div>
<div class="line">  *rx_head++ = CMD_MODE_ACTIVE;</div>
<div class="line">  *rx_head++ = CMD_STATE;</div>
<div class="line"></div>
<div class="line">  memset(&amp;state, 0, <span class="keyword">sizeof</span>(state));</div>
<div class="line">  <a class="code" href="core_8h.html#a954f39fe5652611f5a20f74289b0cfbf">BSP430_CORE_ENABLE_INTERRUPT</a>();</div>
<div class="line">  <span class="keywordflow">while</span> (1) {</div>
<div class="line">    <span class="keywordtype">int</span> enter_sleep = 0;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> sleep_utt;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> wake_utt;</div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">      <span class="keywordtype">int</span> c;</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">while</span> (0 &lt;= ((c = consume_rx()))) {</div>
<div class="line">        <span class="keyword">const</span> sCommand * cmdp = commands;</div>
<div class="line">        <span class="keyword">const</span> sCommand * <span class="keyword">const</span> commands_end = commands + <span class="keyword">sizeof</span>(commands) / <span class="keyword">sizeof</span>(*commands);</div>
<div class="line">        <span class="keywordflow">while</span> ((cmdp &lt; commands_end) &amp;&amp; (cmdp-&gt;cmd != c)) {</div>
<div class="line">          ++cmdp;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (cmdp-&gt;cmd == c) {</div>
<div class="line">          <a class="code" href="console_8h.html#a6e0a771b0a8f2034a7f49684b107542e">cputs</a>(cmdp-&gt;description);</div>
<div class="line">          <span class="keywordflow">switch</span> (cmdp-&gt;cmd) {</div>
<div class="line">            <span class="keywordflow">case</span> CMD_MODE_ACTIVE:</div>
<div class="line">              state.lpm_bits = 0;</div>
<div class="line">              state.lpm_description = <span class="stringliteral">&quot;Active&quot;</span>;</div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> CMD_MODE_LPM0:</div>
<div class="line">              state.lpm_bits = <a class="code" href="msp430_8h.html#a44fde789b84d1b15c41e577d6a080eff">LPM0_bits</a>;</div>
<div class="line">              state.lpm_description = <span class="stringliteral">&quot;LPM0&quot;</span>;</div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> CMD_MODE_LPM1:</div>
<div class="line">              state.lpm_bits = <a class="code" href="msp430_8h.html#a1de78c710e50d6f742f5676dfbffdedf">LPM1_bits</a>;</div>
<div class="line">              state.lpm_description = <span class="stringliteral">&quot;LPM1&quot;</span>;</div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> CMD_MODE_LPM2:</div>
<div class="line">              state.lpm_bits = <a class="code" href="msp430_8h.html#a8af1e5b3633693d9439d284100183004">LPM2_bits</a>;</div>
<div class="line">              state.lpm_description = <span class="stringliteral">&quot;LPM2&quot;</span>;</div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> CMD_MODE_LPM3:</div>
<div class="line">              state.lpm_bits = <a class="code" href="msp430_8h.html#ae8217664a1729103e247c6984d1744cc">LPM3_bits</a>;</div>
<div class="line">              state.lpm_description = <span class="stringliteral">&quot;LPM3&quot;</span>;</div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> CMD_MODE_LPM4:</div>
<div class="line">              state.lpm_bits = <a class="code" href="msp430_8h.html#a97eaedd508e6f77e34a49433f8e9e2eb">LPM4_bits</a>;</div>
<div class="line">              state.lpm_description = <span class="stringliteral">&quot;LPM4&quot;</span>;</div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line"><span class="preprocessor">#ifdef BSP430_PMM_ENTER_LPMXp5_NI</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">case</span> CMD_MODE_LPM3p5:</div>
<div class="line">              state.lpm_bits = <a class="code" href="core_8h.html#ac98f22bd2238bfdadf9c7d2a7a8bcc8f">BSP430_CORE_LPM_LPMXp5</a> | <a class="code" href="msp430_8h.html#ae8217664a1729103e247c6984d1744cc">LPM3_bits</a>;</div>
<div class="line">              state.lpm_description = <span class="stringliteral">&quot;LPM3.5&quot;</span>;</div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> CMD_MODE_LPM4p5:</div>
<div class="line">              state.lpm_bits = <a class="code" href="core_8h.html#ac98f22bd2238bfdadf9c7d2a7a8bcc8f">BSP430_CORE_LPM_LPMXp5</a> | <a class="code" href="msp430_8h.html#a97eaedd508e6f77e34a49433f8e9e2eb">LPM4_bits</a>;</div>
<div class="line">              state.lpm_description = <span class="stringliteral">&quot;LPM4.5&quot;</span>;</div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PMM_ENTER_LPMXp5_NI */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">case</span> CMD_HELP: {</div>
<div class="line">              cmdp = commands;</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Available commands:\n&quot;</span>);</div>
<div class="line">              <span class="keywordflow">while</span> (cmdp &lt; commands_end) {</div>
<div class="line">                <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\t%c : %s\n&quot;</span>, cmdp-&gt;cmd, cmdp-&gt;description);</div>
<div class="line">                ++cmdp;</div>
<div class="line">              }</div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">case</span> CMD_STATE:</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;MCLK rate: %lu Hz\n&quot;</span>, <a class="code" href="clock_8h.html#a5d5257ff00b9fafcd86e4f5eaa73ee79">ulBSP430clockMCLK_Hz_ni</a>());</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;SMCLK rate: %lu Hz\n&quot;</span>, <a class="code" href="clock_8h.html#a3a4574eaba535c1f3fc60a9063daa1b6">ulBSP430clockSMCLK_Hz_ni</a>());</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ACLK rate: %u Hz\n&quot;</span>, <a class="code" href="clock_8h.html#a81d3191393783b4479969fed1019f40b">uiBSP430clockACLK_Hz_ni</a>());</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;LFXT1: %s\n&quot;</span>, <a class="code" href="clock_8h.html#a7a0cdc169aac90a5c877b3ca09a4608d">BSP430_CLOCK_LFXT1_IS_FAULTED_NI</a>() ? <span class="stringliteral">&quot;FAULTED&quot;</span> : <span class="stringliteral">&quot;stable&quot;</span>);</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Uptime (ACLK ticks): %lu\n&quot;</span>, <a class="code" href="uptime_8h.html#ae3e58aab92925d2ee1d3fd8f06031c9b">ulBSP430uptime_ni</a>());</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Selected idle state: %s\n&quot;</span>, state.lpm_description);</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Clocks will %s\n&quot;</span>, state.hold_clock ? <span class="stringliteral">&quot;freeze&quot;</span> : <span class="stringliteral">&quot;run&quot;</span>);</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Serial will %s\n&quot;</span>, state.hold_serial ? <span class="stringliteral">&quot;be held&quot;</span> : <span class="stringliteral">&quot;be active&quot;</span>);</div>
<div class="line"><span class="preprocessor">#if APP_ENABLE_COREV</span></div>
<div class="line"><span class="preprocessor"></span>              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Core voltage level %d\n&quot;</span>, PMMCTL0 &amp; <a class="code" href="msp430_8h.html#a4aa3f2a0135a48433168c58a596e88da">PMMCOREV_3</a>);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* APP_ENABLE_COREV */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>              <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> CMD_HOLD_SERIAL:</div>
<div class="line">              state.hold_serial = ! state.hold_serial;</div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> CMD_HOLD_CLOCK:</div>
<div class="line">              state.hold_clock = ! state.hold_clock;</div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> CMD_SLEEP:</div>
<div class="line">              enter_sleep = 1;</div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line"><span class="preprocessor">#if APP_ENABLE_COREV</span></div>
<div class="line"><span class="preprocessor"></span>            <span class="keywordflow">case</span> CMD_COREV_INCR:</div>
<div class="line">            <span class="keywordflow">case</span> CMD_COREV_DECR: {</div>
<div class="line">              <span class="keywordtype">int</span> delta = 0;</div>
<div class="line">              <span class="keywordtype">int</span> rc = 0;</div>
<div class="line">              <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">              <span class="keywordflow">do</span> {</div>
<div class="line">                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level = PMMCTL0 &amp; <a class="code" href="msp430_8h.html#a4aa3f2a0135a48433168c58a596e88da">PMMCOREV_3</a>;</div>
<div class="line">                <span class="keywordflow">if</span> ((cmdp-&gt;cmd == CMD_COREV_INCR) &amp;&amp; (level &lt; PMMCOREV_3)) {</div>
<div class="line">                  delta = 1;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> ((cmdp-&gt;cmd == CMD_COREV_DECR) &amp;&amp; (level &gt; <a class="code" href="msp430_8h.html#a34ca0e5c11c8b5df96c3c0897728ca8f">PMMCOREV_0</a>)) {</div>
<div class="line">                  delta = -1;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> (0 != delta) {</div>
<div class="line">                  rc = <a class="code" href="pmm_8h.html#ac3621d45ad0e516384a5dce097dadba9">iBSP430pmmSetCoreVoltageLevel_ni</a>(level + delta);</div>
<div class="line">                }</div>
<div class="line">              } <span class="keywordflow">while</span> (0);</div>
<div class="line">              <a class="code" href="core_8h.html#a954f39fe5652611f5a20f74289b0cfbf">BSP430_CORE_ENABLE_INTERRUPT</a>();</div>
<div class="line">              <span class="keywordflow">if</span> (0 == delta) {</div>
<div class="line">                <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Core voltage at limit\n&quot;</span>);</div>
<div class="line">              } <span class="keywordflow">else</span> {</div>
<div class="line">                <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Core voltage adjusted %d to %d rv %d\n&quot;</span>, delta, PMMCTL0 &amp; PMMCOREV_3, rc);</div>
<div class="line">              }</div>
<div class="line">              <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;PMM: CTL0 %04x CTL1 %04x\n&quot;</span>, PMMCTL0, PMMCTL1);</div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* APP_ENABLE_COREV */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>          }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">          <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Unrecognized command: %c\n&quot;</span>, c);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">while</span> (! enter_sleep);</div>
<div class="line">    <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">    sleep_utt = <a class="code" href="uptime_8h.html#ae3e58aab92925d2ee1d3fd8f06031c9b">ulBSP430uptime_ni</a>();</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Entering idle mode at %lu: %s\n&quot;</span>, sleep_utt, state.lpm_description);</div>
<div class="line">    <span class="keywordflow">if</span> (state.lpm_bits &amp; <a class="code" href="core_8h.html#ac98f22bd2238bfdadf9c7d2a7a8bcc8f">BSP430_CORE_LPM_LPMXp5</a>) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;NOTE: Will use LPMx.5: press button to exit\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (state.hold_clock) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Suspending clock\n&quot;</span>);</div>
<div class="line">      <a class="code" href="uptime_8h.html#a62fc249f2c4699ab77b408e3488ca4b5">vBSP430uptimeSuspend_ni</a>();</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (state.hold_serial) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Disabling serial; press button to wake\n\n&quot;</span>);</div>
<div class="line">      <a class="code" href="serial_8h.html#a4e6aa007adea01b8d1760fd3dc31b5e2">iBSP430serialSetHold_ni</a>(tty, 1);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (b0hpl-&gt;in &amp; <a class="code" href="platform_8h.html#a2d2bb16f09ab8d94f795e717a946a509">BSP430_PLATFORM_BUTTON0_PORT_BIT</a>) {</div>
<div class="line">      b0hpl-&gt;ies |= <a class="code" href="platform_8h.html#a2d2bb16f09ab8d94f795e717a946a509">BSP430_PLATFORM_BUTTON0_PORT_BIT</a>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      b0hpl-&gt;ies &amp;= ~<a class="code" href="platform_8h.html#a2d2bb16f09ab8d94f795e717a946a509">BSP430_PLATFORM_BUTTON0_PORT_BIT</a>;</div>
<div class="line">    }</div>
<div class="line">    b0hpl-&gt;ifg &amp;= ~<a class="code" href="platform_8h.html#a2d2bb16f09ab8d94f795e717a946a509">BSP430_PLATFORM_BUTTON0_PORT_BIT</a>;</div>
<div class="line">    b0hpl-&gt;ie |= <a class="code" href="platform_8h.html#a2d2bb16f09ab8d94f795e717a946a509">BSP430_PLATFORM_BUTTON0_PORT_BIT</a>;</div>
<div class="line">    <span class="keywordflow">if</span> (0 == state.lpm_bits) {</div>
<div class="line">      button = 0;</div>
<div class="line">      <a class="code" href="core_8h.html#a954f39fe5652611f5a20f74289b0cfbf">BSP430_CORE_ENABLE_INTERRUPT</a>();</div>
<div class="line">      <span class="keywordflow">while</span> ((rx_head == rx_tail) &amp;&amp; (! button)) {</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="preprocessor">#ifdef BSP430_PMM_ENTER_LPMXp5_NI</span></div>
<div class="line"><span class="preprocessor"></span>      <span class="keywordflow">if</span> (state.lpm_bits &amp; <a class="code" href="core_8h.html#ac98f22bd2238bfdadf9c7d2a7a8bcc8f">BSP430_CORE_LPM_LPMXp5</a>) {</div>
<div class="line">        <a class="code" href="pmm_8h.html#a77f7471bb2f76ad4c4173a9a4afa3055">BSP430_PMM_ENTER_LPMXp5_NI</a>();</div>
<div class="line">      }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PMM_ENTER_LPMXp5_NI */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>      <a class="code" href="core_8h.html#ab3ba0bc9be345eb561a58747da602704">BSP430_CORE_LPM_ENTER_NI</a>(state.lpm_bits | <a class="code" href="msp430_8h.html#a1e3cee306f51b98da4e4c97ab118f506">GIE</a>);</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">    wake_utt = <a class="code" href="uptime_8h.html#ae3e58aab92925d2ee1d3fd8f06031c9b">ulBSP430uptime_ni</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (state.hold_serial) {</div>
<div class="line">      <a class="code" href="serial_8h.html#a4e6aa007adea01b8d1760fd3dc31b5e2">iBSP430serialSetHold_ni</a>(tty, 0);</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Serial now awake\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (state.hold_clock) {</div>
<div class="line">      <a class="code" href="uptime_8h.html#af8e943e205552a5c9aa1532ca1347b0b">vBSP430uptimeResume_ni</a>();</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Clock resumed\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Left idle mode at %lu: %lu asleep\n&quot;</span>, wake_utt, wake_utt - sleep_utt);</div>
<div class="line">    <a class="code" href="core_8h.html#a954f39fe5652611f5a20f74289b0cfbf">BSP430_CORE_ENABLE_INTERRUPT</a>();</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="ex_bootstrap_applpm_config"></a>
bsp430_config.h</h1>
<div class="fragment"><div class="line"><span class="comment">/* Although a crystal supports more accurate timing, it does increase</span></div>
<div class="line"><span class="comment"> * current.  Disable it unless otherwise requested */</span></div>
<div class="line"><span class="preprocessor">#ifndef BSP430_PLATFORM_BOOT_CONFIGURE_LFXT1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BSP430_PLATFORM_BOOT_CONFIGURE_LFXT1 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PLATFORM_BOOT_CONFIGURE_LFXT1 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Application does output: support spin-for-jumper */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_PLATFORM_SPIN_FOR_JUMPER 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Support console output */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_CONSOLE 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Monitor uptime and provide generic ACLK-driven timer */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_UPTIME 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Request a button */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_PLATFORM_BUTTON0 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* And LEDs, configured at boot */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_LED 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BSP430_PLATFORM_BOOT_CONFIGURE_LEDS 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifndef APP_CONFIGURE_PORTS_FOR_LPM</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define APP_CONFIGURE_PORTS_FOR_LPM 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* APP_CONFIGURE_PORTS_FOR_LPM */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Get platform defaults */</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="bsp430__config_8h.html" title="BSP430 configuration directives for generic platform support.">bsp430/platform/bsp430_config.h</a>&gt;</span></div>
</div><!-- fragment --><h1><a class="anchor" id="ex_bootstrap_applpm_make"></a>
Makefile</h1>
<div class="fragment"><div class="line">MCLK ?= 1000000</div>
<div class="line">AUX_CPPFLAGS += -DBSP430_CLOCK_NOMINAL_MCLK_HZ=$(MCLK)</div>
<div class="line">PLATFORM ?= exp430fr5739</div>
<div class="line">MODULES = $(MODULES_PLATFORM)</div>
<div class="line">MODULES += $(MODULES_UPTIME)</div>
<div class="line">MODULES += $(MODULES_CONSOLE)</div>
<div class="line">MODULES += periph/port</div>
<div class="line">MODULES += periph/sys</div>
<div class="line">MODULES += periph/pmm</div>
<div class="line">MODULES += lpm</div>
<div class="line">SRC=main.c</div>
<div class="line">include $(BSP430_ROOT)/examples/Makefile.common</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Oct 2 2012 14:39:04 for BSP430 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.1.2
</small></address>
</body>
</html>
