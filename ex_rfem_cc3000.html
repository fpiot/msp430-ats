<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>BSP430: CC3000 SimpleLink Exploration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BSP430
   &#160;<span id="projectnumber">20130325</span>
   </div>
   <div id="projectbrief">Board Support Package for MSP430 microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">CC3000 SimpleLink Exploration </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This example is a fairly complex program demonstrating the basic goal that drove BSP430 development: the ability to quickly develop tools to explore new capabilities in an interactive fashion without being tied to a particular MSP430 product line or board, and to abstract the capabilities as modules that could be used in other applications.</p>
<p>The <a href="http://processors.wiki.ti.com/index.php/CC3000_Wi-Fi_for_MCU">Texas Instruments SimpleLink(TM) CC3000 Wi-Fi SOC</a> is a solution intended to enable microcontrollers to communicate over 802.11 Wi-Fi networks. It is available in RF evaluation module form-factor, and comes with example programs from Texas Instruments that are mostly tested only on the <a href="http://www.ti.com/tool/msp-exp430fr5739">MSP-EXP430FR5739 "Fraunchpad"</a>.</p>
<p>The example here uses the TI-provided host driver with a BSP430 SPI interface to provide an interactive program to invoke various capabilities of the SimpleLink hardware. The Fraunchpad has extremely limited memory (16 kB including the space used for the packet buffers) and simply can't support an interactive application with extensive text help and command processing. It's close, though; this application takes slightly more than 20 kB when compiled with <a href="https://sourceforge.net/projects/mspgcc/">MSPGCC</a> for the <a href="http://www.ti.com/tool/msp-exp430f5438">MSP-EXP430F5438</a>.</p>
<p>Below are the commands supported: </p>
<pre class="fragment">&gt; help
help # No help available
info # No help available
  load # load wlan AP params from INFO_B
  erase # erase INFO_B
  store # store wlan AP params in INFO_B
nvmem # No help available
  mac # get mac address
  read fileid [len(=128) [ofs(=0)]] # read block from nvmem file
  sp # read firmware service pack level
wlan # No help available
  start # power-up CC3000
  status # get CC3000 status and AP config
  connect # connect to specified access point using AP config
  sectype [{sectype}] # Display or set AP sectype
  passphrase [{passphrase}] # Display or set AP passphrase
  ssid [{ssid}] # Display or set AP SSID for connect
  ipconfig # show IP parameters
  disconnect # disconnect from AP
  stop # shut down CC3000
</pre><p>A demonstration boot sequence with a couple commands is: </p>
<pre class="fragment">WLAN test program
System reset bitmask 4; causes:
        RST/NMI
System reset included: BOR POR PUC
PWR_EN at PORT1.7
SPI_IRQ HAL at PORT1.3
CSn HAL at PORT3.0
SPI is USCI5_B0
SPI Pins: MOSI/SDA=P3.1; MISO/SCL=P3.2; CLK=P3.3; STE=P3.0
Oct  2 2012 13:43:22
 0:00.771 Initialize returned 0
And wlan has been started.
AP configuration SSID 'myssid', passphrase 'mypassphrase'
AP security type wpa (2)
WLAN status 0: disconnected
&gt; wla co
connect to ssid 'myssid' by wpa using 'mypassphrase'
con 0 in  0:06.365
 0:12.506 wlan_cb 0x8200 0 at 0 SR 0x1
&gt;  0:13.220 wlan_cb 0x8001 0 at 0 SR 0x1
 0:22.306 wlan_cb 0x8010 20 at 0x5bbe SR 0
 0:22.487 wlan_cb 0x8200 0 at 0 SR 0x1
w ip
IP: 192.168.0.101
NM: 255.255.255.0
GW: 192.168.0.1
DHCP: 192.168.0.1
DNS: 192.168.0.1
MAC: 00.25.ca.02.09.9d
SSID: myssid
&gt;  0:32.486 wlan_cb 0x8200 0 at 0 SR 0x1
</pre><p>Note that asynchronous callbacks from the host driver are displayed interspersed with the commands, and that in this case the AP configuration parameters had been stored in information memory and reloaded on power-up.</p>
<p>Experience while reaching this point revealed that the SimpleLink solution is too immature for serious development, and it is unlikely that the example will be evolved further. Nonetheless, it's a good demonstration of BSP430's capabilities.</p>
<p>To build the program, you will need a copy of the CC3000 Host Driver. This application uses one that has been repackaged to place header files out of the application namespace, support MSPGCC, fix a few bugs, and support building as a library that can be linked into an application. It can be obtained from: <a href="http://github.com/pabigot/cc3000">http://github.com/pabigot/cc3000</a></p>
<h1><a class="anchor" id="ex_rfem_cc3000_spi"></a>
cc3000spi.c</h1>
<p>The CC3000 Host Driver library is independent of the underlying interface via SPI. A demonstration interface for specific MSP430 processors is part of the TI example programs, but it is rather confusing and has board-specific material tightly integrated.</p>
<p>The file below bridges between the host driver and BSP430's serial abstraction following the specfication at the <a href="http://processors.wiki.ti.com/index.php/CC3000_Host_Driver_Porting_Guide">CC3000 Host Driver Porting Guide</a>.</p>
<div class="fragment"><div class="line"><span class="comment">/* Copyright 2012-2013, Peter A. Bigot</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * All rights reserved.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><span class="comment"> * modification, are permitted provided that the following conditions are met:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * * Redistributions of source code must retain the above copyright notice,</span></div>
<div class="line"><span class="comment"> *   this list of conditions and the following disclaimer.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * * Redistributions in binary form must reproduce the above copyright notice,</span></div>
<div class="line"><span class="comment"> *   this list of conditions and the following disclaimer in the documentation</span></div>
<div class="line"><span class="comment"> *   and/or other materials provided with the distribution.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * * Neither the name of the software nor the names of its contributors may be</span></div>
<div class="line"><span class="comment"> *   used to endorse or promote products derived from this software without</span></div>
<div class="line"><span class="comment"> *   specific prior written permission.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span></div>
<div class="line"><span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span></div>
<div class="line"><span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span></div>
<div class="line"><span class="comment"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE</span></div>
<div class="line"><span class="comment"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span></div>
<div class="line"><span class="comment"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span></div>
<div class="line"><span class="comment"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span></div>
<div class="line"><span class="comment"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span></div>
<div class="line"><span class="comment"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span></div>
<div class="line"><span class="comment"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span></div>
<div class="line"><span class="comment"> * POSSIBILITY OF SUCH DAMAGE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="platform_8h.html" title="Entrypoint for platform-specific capabilities.">bsp430/platform.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="uptime_8h.html" title="Support for maintaining a system uptime counter.">bsp430/utility/uptime.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="port_8h.html" title="Hardware presentation/abstraction for Digital I/O Port (PORT#/PORT#_R)">bsp430/periph/port.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="serial_8h.html" title="Declarations for abstracted serial interface.">bsp430/serial.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="cc3000spi_8h.html" title="CC3000 Host Driver Interface for BSP430.">cc3000spi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/wlan.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/hci.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/spi.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(__MSP430FR5739__)</span></div>
<div class="line"><span class="preprocessor"></span>__attribute__((__section__(<span class="stringliteral">&quot;.rodata&quot;</span>)))</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* __MSP430FR5739__ */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> wlan_tx_buffer[<a class="code" href="cc3000spi_8h.html#a91296e239f43b23894ff57a3d196a644">BSP430_CC3000SPI_TX_BUFFER_SIZE</a>];</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if defined(__MSP430FR5739__)</span></div>
<div class="line"><span class="preprocessor"></span>__attribute__((__section__(<span class="stringliteral">&quot;.rodata&quot;</span>)))</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* __MSP430FR5739__ */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> wlan_rx_buffer[<a class="code" href="cc3000spi_8h.html#ad0be8d9dad7f10d193314afbb436822e">BSP430_CC3000SPI_RX_BUFFER_SIZE</a>];</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define SPIFLAG_INITIALIZED 0x01</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define SPIFLAG_DID_FIRST_WRITE 0x02</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define CC3000_SPI_OPCODE_WRITE 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define CC3000_SPI_OPCODE_READ 3</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> spiFlags_;</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430halSERIAL.html">hBSP430halSERIAL</a> spi_;</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430halPORT.html">hBSP430halPORT</a> halCSn_;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <a class="code" href="structsBSP430hplPORT__IE__8.html">sBSP430hplPORTIE</a> * spiIRQport_;</div>
<div class="line"><span class="keyword">static</span> gcSpiHandleRx rxCallback_ni_;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Assert chip select by clearing CSn */</span></div>
<div class="line"><span class="preprocessor">#define CS_ASSERT() do {                                                \</span></div>
<div class="line"><span class="preprocessor">    BSP430_PORT_HAL_HPL_OUT(halCSn_) &amp;= ~BSP430_RFEM_SPI0CSn_PORT_BIT;  \</span></div>
<div class="line"><span class="preprocessor">  } while (0)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* De-assert chip select by setting CSn */</span></div>
<div class="line"><span class="preprocessor">#define CS_DEASSERT() do {                                              \</span></div>
<div class="line"><span class="preprocessor">    BSP430_PORT_HAL_HPL_OUT(halCSn_) |= BSP430_RFEM_SPI0CSn_PORT_BIT;   \</span></div>
<div class="line"><span class="preprocessor">  } while (0)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Implementation of tWlanReadInterruptPin for wlan_init().</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This is used in wlan_start() to detect that the CC3000 has</span></div>
<div class="line"><span class="comment"> * successfully powered up. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">long</span></div>
<div class="line">readWlanInterruptPin_ (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> spiIRQport_-&gt;in &amp; <a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Implementation of tWlanInterruptEnable for wlan_init().</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Required by the interface, but not used by the host driver</span></div>
<div class="line"><span class="comment"> * implementation.  Used internally. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">wlanInterruptEnable_ (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  spiIRQport_-&gt;ie |= <a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Implementation of tWlanInterruptDisable for wlan_init().</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Required by the interface, but not used by the host driver</span></div>
<div class="line"><span class="comment"> * implementation.  Used internally.  */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">wlanInterruptDisable_ (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  spiIRQport_-&gt;ie &amp;= ~<a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Implementation of tWriteWlanPin for wlan_init().</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This is used in wlan_start() to power-up the CC3000, and in</span></div>
<div class="line"><span class="comment"> * wlan_stop() to shut it down again. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">writeWlanPin_ (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> val)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">volatile</span> <a class="code" href="structsBSP430hplPORT__IE__8.html">sBSP430hplPORTIE</a> * <span class="keyword">const</span> pwr_en_port = <a class="code" href="port_8h.html#ab315de00d9b9e34a6bb772103b05f0f8">xBSP430hplLookupPORTIE</a>(<a class="code" href="rfem_8h.html#a8ef1d1dc188b30379f946635a3920f07">BSP430_RFEM_PWR_EN_PORT_PERIPH_HANDLE</a>);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (val) {</div>
<div class="line">    pwr_en_port-&gt;out |= <a class="code" href="rfem_8h.html#a02b8877017074eff5126882bdee9f840">BSP430_RFEM_PWR_EN_PORT_BIT</a>;</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    pwr_en_port-&gt;out &amp;= ~<a class="code" href="rfem_8h.html#a02b8877017074eff5126882bdee9f840">BSP430_RFEM_PWR_EN_PORT_BIT</a>;</div>
<div class="line">    spiFlags_ &amp;= ~SPIFLAG_INITIALIZED;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line"><a class="code" href="cc3000spi_8h.html#a18c48988f94c6984548d28e802377344">iBSP430cc3000spiInitialize</a> (tWlanCB wlan_cb,</div>
<div class="line">                            tFWPatches firmware_patch_fn,</div>
<div class="line">                            tDriverPatches driver_patch_fn,</div>
<div class="line">                            tBootLoaderPatches boot_loader_patch_fn)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (NULL == <a class="code" href="serial_8h.html#ad311104b2da6d177b2ae5ec0b29e7207">hBSP430serialLookup</a>(<a class="code" href="rfem_8h.html#a591494d7035a46d6f8e7d47151378b84">BSP430_RFEM_SPI0_PERIPH_HANDLE</a>)) {</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  spiIRQport_ = <a class="code" href="port_8h.html#ab315de00d9b9e34a6bb772103b05f0f8">xBSP430hplLookupPORTIE</a>(<a class="code" href="rfem_8h.html#a526c15df0b78d0e456a1d8777a47ec43">BSP430_RFEM_SPI_IRQ_PORT_PERIPH_HANDLE</a>);</div>
<div class="line">  <span class="keywordflow">if</span> (NULL == spiIRQport_) {</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  halCSn_ = <a class="code" href="port_8h.html#a039c56ddc64f51922244aac149f7a853">hBSP430portLookup</a>(<a class="code" href="rfem_8h.html#af2db206437914504f599c7edd1aa6443">BSP430_RFEM_SPI0CSn_PORT_PERIPH_HANDLE</a>);</div>
<div class="line">  <span class="keywordflow">if</span> (NULL == halCSn_) {</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  wlan_init(wlan_cb, firmware_patch_fn, driver_patch_fn, boot_loader_patch_fn,</div>
<div class="line">            readWlanInterruptPin_, wlanInterruptEnable_, wlanInterruptDisable_,</div>
<div class="line">            writeWlanPin_);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">processSpiIRQ_ (<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsBSP430halISRIndexedChainNode.html">sBSP430halISRIndexedChainNode</a> * cb,</div>
<div class="line">                <span class="keywordtype">void</span> * context,</div>
<div class="line">                <span class="keywordtype">int</span> idx)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (spiFlags_ &amp; SPIFLAG_INITIALIZED) {</div>
<div class="line">    <span class="keywordtype">int</span> rv;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> opcode = CC3000_SPI_OPCODE_READ;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * rp;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* This is a signal that data is available.  Read it.  Yes, right</span></div>
<div class="line"><span class="comment">     * here in the ISR.  The host driver API would need to be</span></div>
<div class="line"><span class="comment">     * integrated with a multi-tasking OS to do it elsewhere, since</span></div>
<div class="line"><span class="comment">     * it&#39;s not event-driven at the user level. */</span></div>
<div class="line">    CS_ASSERT();</div>
<div class="line">    <span class="comment">/* Read the header.  From that we&#39;ll extract the length. */</span></div>
<div class="line">    rp = wlan_rx_buffer;</div>
<div class="line">    rv = <a class="code" href="serial_8h.html#af6a874dd01b76f52eac4c67fa1aebd4e">iBSP430spiTxRx_ni</a>(spi_, &amp;opcode, <span class="keyword">sizeof</span>(opcode), SPI_HEADER_SIZE-<span class="keyword">sizeof</span>(opcode), rp);</div>
<div class="line">    <span class="keywordflow">if</span> (SPI_HEADER_SIZE == rv) {</div>
<div class="line">      len = (wlan_rx_buffer[HCI_PACKET_LENGTH_OFFSET] &lt;&lt; 8) | wlan_rx_buffer[1 + HCI_PACKET_LENGTH_OFFSET];</div>
<div class="line">      rp += SPI_HEADER_SIZE;</div>
<div class="line">      rv = <a class="code" href="serial_8h.html#af6a874dd01b76f52eac4c67fa1aebd4e">iBSP430spiTxRx_ni</a>(spi_, NULL, 0, len, rp);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      rv = -1;</div>
<div class="line">    }</div>
<div class="line">    CS_DEASSERT();</div>
<div class="line">    <span class="keywordflow">if</span> (0 &lt; rv) {</div>
<div class="line">      <span class="comment">/* Turn off the interrupt while we process this message.  The</span></div>
<div class="line"><span class="comment">       * driver will invoke SpiResume() to turn it back on. */</span></div>
<div class="line">      wlanInterruptDisable_();</div>
<div class="line"></div>
<div class="line">      <span class="comment">/* Pass the packet off to the driver.  Again, yes, right here in</span></div>
<div class="line"><span class="comment">       * the ISR. */</span></div>
<div class="line">      rxCallback_ni_(rp);</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">/* If not initialized, this is the IRQ raised by the CC3000 to</span></div>
<div class="line"><span class="comment">     * notify the MCU that it is now powered up and active.  No data</span></div>
<div class="line"><span class="comment">     * to read, no callback to invoke. */</span></div>
<div class="line">    spiFlags_ |= SPIFLAG_INITIALIZED;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430halISRIndexedChainNode.html">sBSP430halISRIndexedChainNode</a> spi_irq_cb = { .<a class="code" href="structsBSP430halISRIndexedChainNode.html#a88c6166d592b2f7720b89aac0d785c7a">callback</a> = processSpiIRQ_ };</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">SpiOpen (gcSpiHandleRx pfRxHandler)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="structsBSP430halPORT.html">hBSP430halPORT</a> spi_irq_hal = <a class="code" href="port_8h.html#a039c56ddc64f51922244aac149f7a853">hBSP430portLookup</a>(<a class="code" href="rfem_8h.html#a526c15df0b78d0e456a1d8777a47ec43">BSP430_RFEM_SPI_IRQ_PORT_PERIPH_HANDLE</a>);</div>
<div class="line">  <span class="keyword">volatile</span> <a class="code" href="structsBSP430hplPORT__IE__8.html">sBSP430hplPORTIE</a> * <span class="keyword">const</span> pwr_en_port = <a class="code" href="port_8h.html#ab315de00d9b9e34a6bb772103b05f0f8">xBSP430hplLookupPORTIE</a>(<a class="code" href="rfem_8h.html#a8ef1d1dc188b30379f946635a3920f07">BSP430_RFEM_PWR_EN_PORT_PERIPH_HANDLE</a>);</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> spi_irq_pin = <a class="code" href="port_8h.html#aa9b72a778f0f690c08bba27871c4d374">iBSP430portBitPosition</a>(<a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>);</div>
<div class="line">  <a class="code" href="core_8h.html#a15976e4890ec6eacf5cbddf25c5b11c7">BSP430_CORE_INTERRUPT_STATE_T</a> istate;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ae4bfa3ada65bbdf28947828ce7966ec1">BSP430_CORE_SAVE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    <span class="keywordflow">if</span> (spi_) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Open the device for 3-wire SPI.  Per</span></div>
<div class="line"><span class="comment">     * http://processors.wiki.ti.com/index.php/CC3000_Host_Programming_Guide#CC3000_SPI_Operation</span></div>
<div class="line"><span class="comment">     * the CC3000 can accept clock speeds up to 26MHz, so we might as</span></div>
<div class="line"><span class="comment">     * well just use undivided SMCLK. */</span></div>
<div class="line">    spi_ = <a class="code" href="serial_8h.html#a40983f5ed625fd352698117786691dd5">hBSP430serialOpenSPI</a>(<a class="code" href="serial_8h.html#ad311104b2da6d177b2ae5ec0b29e7207">hBSP430serialLookup</a>(<a class="code" href="rfem_8h.html#a591494d7035a46d6f8e7d47151378b84">BSP430_RFEM_SPI0_PERIPH_HANDLE</a>),</div>
<div class="line">                                <a class="code" href="serial_8h.html#a84cdc2d11d71d5fd97b96f427c239cb9">BSP430_SERIAL_ADJUST_CTL0_INITIALIZER</a>(<a class="code" href="msp430_8h.html#a199ca0dc5cd21e551af5c23d9beec934">UCMSB</a> | <a class="code" href="msp430_8h.html#a83010f7d75e7283b79244ce5a4fa7870">UCMST</a>),</div>
<div class="line">                                <a class="code" href="msp430_8h.html#a1d80b08053e2c8dcad61e17d520da303">UCSSEL_2</a>, 1);</div>
<div class="line">    <span class="keywordflow">if</span> (! spi_) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Clear the SPI flags */</span></div>
<div class="line">    spiFlags_ = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Preserve the callback pointer */</span></div>
<div class="line">    rxCallback_ni_ = pfRxHandler;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Configure CC3000 power-enable pin and turn off power.  It&#39;ll be</span></div>
<div class="line"><span class="comment">     * turned on in wlan_start(). */</span></div>
<div class="line">    pwr_en_port-&gt;out &amp;= ~<a class="code" href="rfem_8h.html#a02b8877017074eff5126882bdee9f840">BSP430_RFEM_PWR_EN_PORT_BIT</a>;</div>
<div class="line">    pwr_en_port-&gt;dir |= <a class="code" href="rfem_8h.html#a02b8877017074eff5126882bdee9f840">BSP430_RFEM_PWR_EN_PORT_BIT</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Clear chip select (set value before making it an output) */</span></div>
<div class="line">    CS_DEASSERT();</div>
<div class="line">    <a class="code" href="port_8h.html#a464269017051d0faa11317c6627db1b5">BSP430_PORT_HAL_HPL_DIR</a>(halCSn_) |= <a class="code" href="rfem_8h.html#ac34b2d6647910584c94c65e19cae23f4">BSP430_RFEM_SPI0CSn_PORT_BIT</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Hook into the interrupt vector for the SPI IRQ, then enable</span></div>
<div class="line"><span class="comment">     * interrupts on falling edge.  When wlan_start() turns on power,</span></div>
<div class="line"><span class="comment">     * we&#39;ll get an interrupt indicating the chip is ready (wlan_start()</span></div>
<div class="line"><span class="comment">     * also busy-waits internally for this event). */</span></div>
<div class="line">    spi_irq_cb.<a class="code" href="structsBSP430halISRIndexedChainNode.html#a0bd8af32ae8efbd574e2010b134f0d7f">next_ni</a> = spi_irq_hal-&gt;<a class="code" href="structsBSP430halPORT.html#a8b9fd95d1ee0929db93ae602b5e32767">pin_cbchain_ni</a>[spi_irq_pin];</div>
<div class="line">    spi_irq_hal-&gt;<a class="code" href="structsBSP430halPORT.html#a8b9fd95d1ee0929db93ae602b5e32767">pin_cbchain_ni</a>[spi_irq_pin] = &amp;spi_irq_cb;</div>
<div class="line">    spiIRQport_-&gt;ies |= <a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>;</div>
<div class="line">    spiIRQport_-&gt;dir &amp;= ~<a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>;</div>
<div class="line">    spiIRQport_-&gt;ifg &amp;= ~<a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>;</div>
<div class="line">    wlanInterruptEnable_();</div>
<div class="line">  } <span class="keywordflow">while</span> (0);</div>
<div class="line">  <a class="code" href="core_8h.html#a5e9ec46fa426727b23b14cd505e5bbec">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">SpiClose (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="structsBSP430halPORT.html">hBSP430halPORT</a> spi_irq_hal = <a class="code" href="port_8h.html#a039c56ddc64f51922244aac149f7a853">hBSP430portLookup</a>(<a class="code" href="rfem_8h.html#a526c15df0b78d0e456a1d8777a47ec43">BSP430_RFEM_SPI_IRQ_PORT_PERIPH_HANDLE</a>);</div>
<div class="line">  <span class="keyword">volatile</span> <a class="code" href="structsBSP430hplPORT__IE__8.html">sBSP430hplPORTIE</a> * <span class="keyword">const</span> pwr_en_port = <a class="code" href="port_8h.html#ab315de00d9b9e34a6bb772103b05f0f8">xBSP430hplLookupPORTIE</a>(<a class="code" href="rfem_8h.html#a8ef1d1dc188b30379f946635a3920f07">BSP430_RFEM_PWR_EN_PORT_PERIPH_HANDLE</a>);</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> spi_irq_pin = <a class="code" href="port_8h.html#aa9b72a778f0f690c08bba27871c4d374">iBSP430portBitPosition</a>(<a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>);</div>
<div class="line">  <a class="code" href="core_8h.html#a15976e4890ec6eacf5cbddf25c5b11c7">BSP430_CORE_INTERRUPT_STATE_T</a> istate;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ae4bfa3ada65bbdf28947828ce7966ec1">BSP430_CORE_SAVE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    <span class="keywordflow">if</span> (! spi_) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Disable interrupts, clear pending interrupt, and unhook from</span></div>
<div class="line"><span class="comment">     * the ISR chain.  Set the GPIO to output low. */</span></div>
<div class="line">    tSLInformation.WlanInterruptDisable();</div>
<div class="line">    spiIRQport_-&gt;ifg &amp;= ~<a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>;</div>
<div class="line">    spi_irq_hal-&gt;<a class="code" href="structsBSP430halPORT.html#a8b9fd95d1ee0929db93ae602b5e32767">pin_cbchain_ni</a>[spi_irq_pin] = spi_irq_cb.<a class="code" href="structsBSP430halISRIndexedChainNode.html#a0bd8af32ae8efbd574e2010b134f0d7f">next_ni</a>;</div>
<div class="line">    spiIRQport_-&gt;out &amp;= ~<a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>;</div>
<div class="line">    spiIRQport_-&gt;dir |= <a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Close down SPI peripheral */</span></div>
<div class="line">    (void)<a class="code" href="serial_8h.html#a9ef360a3a47ffaef50409a14fbffe5d2">iBSP430serialClose</a>(spi_);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Release the chip select line, just for completeness. */</span></div>
<div class="line">    CS_DEASSERT();</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Power down the CC3000.  In fact, this was already done by</span></div>
<div class="line"><span class="comment">     * wlan_stop(). */</span></div>
<div class="line">    pwr_en_port-&gt;out &amp;= ~<a class="code" href="rfem_8h.html#a02b8877017074eff5126882bdee9f840">BSP430_RFEM_PWR_EN_PORT_BIT</a>;</div>
<div class="line"></div>
<div class="line">    rxCallback_ni_ = NULL;</div>
<div class="line">    spi_ = NULL;</div>
<div class="line">  } <span class="keywordflow">while</span> (0);</div>
<div class="line">  <a class="code" href="core_8h.html#a5e9ec46fa426727b23b14cd505e5bbec">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">long</span></div>
<div class="line">SpiWrite (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * tx_buffer,</div>
<div class="line">          <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> len)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * tp = tx_buffer;</div>
<div class="line">  <a class="code" href="core_8h.html#a15976e4890ec6eacf5cbddf25c5b11c7">BSP430_CORE_INTERRUPT_STATE_T</a> istate;</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Total length of packet must be an even number of octets.  Packet</span></div>
<div class="line"><span class="comment">   * length is user-provided length plus the length of the SPI header,</span></div>
<div class="line"><span class="comment">   * which happens to be odd.  Pad the payload if necessary. */</span></div>
<div class="line">  <span class="keywordflow">if</span> (0x01 &amp; (len + SPI_HEADER_SIZE)) {</div>
<div class="line">    ++len;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* The caller-provided tx_buffer includes SPI_HEADER_SIZE octets at</span></div>
<div class="line"><span class="comment">   * the front, ready for our use. */</span></div>
<div class="line">  *tp++ = CC3000_SPI_OPCODE_WRITE;</div>
<div class="line">  *tp++ = len &gt;&gt; 8;</div>
<div class="line">  *tp++ = len &amp; 0x0FF;</div>
<div class="line">  *tp++ = 0;</div>
<div class="line">  *tp++ = 0;</div>
<div class="line">  len += SPI_HEADER_SIZE;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ae4bfa3ada65bbdf28947828ce7966ec1">BSP430_CORE_SAVE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line"></div>
<div class="line">  CS_ASSERT();</div>
<div class="line">  <span class="comment">/* Spin waiting for acknowledgement, then clear the flag that would</span></div>
<div class="line"><span class="comment">   * look like a read request when we exit. */</span></div>
<div class="line">  <span class="keywordflow">while</span> (0 != readWlanInterruptPin_()) {</div>
<div class="line">    ;</div>
<div class="line">  }</div>
<div class="line">  spiIRQport_-&gt;ifg &amp;= ~<a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>;</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Special handling for first write */</span></div>
<div class="line">  <span class="keywordflow">if</span> (! (spiFlags_ &amp; SPIFLAG_DID_FIRST_WRITE)) {</div>
<div class="line">    <a class="code" href="core_8h.html#a327cb5d1a1607c19c9551a18507bbb63">BSP430_CORE_DELAY_CYCLES</a>((50 * <a class="code" href="clock_8h.html#a6ffd3f4fab35b64d0e8ff8d3179d69d9">BSP430_CLOCK_NOMINAL_MCLK_HZ</a>) / 1000000UL);</div>
<div class="line">    tp = tx_buffer;</div>
<div class="line">    rv = <a class="code" href="serial_8h.html#af6a874dd01b76f52eac4c67fa1aebd4e">iBSP430spiTxRx_ni</a>(spi_, tp, 4, 0, NULL);</div>
<div class="line">    tp += 4;</div>
<div class="line">    len -= 4;</div>
<div class="line">    <a class="code" href="core_8h.html#a327cb5d1a1607c19c9551a18507bbb63">BSP430_CORE_DELAY_CYCLES</a>((50 * <a class="code" href="clock_8h.html#a6ffd3f4fab35b64d0e8ff8d3179d69d9">BSP430_CLOCK_NOMINAL_MCLK_HZ</a>) / 1000000UL);</div>
<div class="line">  }</div>
<div class="line">  rv = <a class="code" href="serial_8h.html#af6a874dd01b76f52eac4c67fa1aebd4e">iBSP430spiTxRx_ni</a>(spi_, tp, len, 0, NULL);</div>
<div class="line">  CS_DEASSERT();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#a5e9ec46fa426727b23b14cd505e5bbec">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> (0 &lt;= rv) ? rv : 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Driver calls this to restore interrupts after processing an</span></div>
<div class="line"><span class="comment"> * incoming message. */</span></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">SpiResumeSpi (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  wlanInterruptEnable_();</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="ex_rfem_cc3000_main"></a>
main.c</h1>
<p>The bulk of the application is taken up with bridge code that interprets user input and invokes CC3000 host API calls. It is mostly of interest in that it demonstrates how to arrange command definitions so they can be easily included/excluded based on available memory.</p>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="platform_8h.html" title="Entrypoint for platform-specific capabilities.">bsp430/platform.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="clock_8h.html" title="Clock-related functions implemented on all MSP430 MCUs.">bsp430/clock.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="port_8h.html" title="Hardware presentation/abstraction for Digital I/O Port (PORT#/PORT#_R)">bsp430/periph/port.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sys_8h.html" title="Hardware presentation/abstraction for SYS peripheral (SYS).">bsp430/periph/sys.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="flash_8h.html" title="Hardware presentation/abstraction for flash memory peripheral (FLASH).">bsp430/periph/flash.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/crtld.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="uptime_8h.html" title="Support for maintaining a system uptime counter.">bsp430/utility/uptime.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="console_8h.html" title="A generic console output capability.">bsp430/utility/console.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="led_8h.html" title="Support for platform-independent LED manipulation.">bsp430/utility/led.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cli_8h.html" title="Basic support for command line processing.">bsp430/utility/cli.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="cc3000spi_8h.html" title="CC3000 Host Driver Interface for BSP430.">cc3000spi.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/wlan.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/nvmem.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/netapp.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;ctype.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Memory is extremely tight on the FR5739 (16 kB including CC3000</span></div>
<div class="line"><span class="comment"> * buffers).  Set these to restrict the set of commands to ones of</span></div>
<div class="line"><span class="comment"> * interest that will fit.  You&#39;ll probably find you&#39;ll need to</span></div>
<div class="line"><span class="comment"> * disable WLAN_CONNECT, which makes this pretty useless.  On the</span></div>
<div class="line"><span class="comment"> * EXP430F5438 the total application size is just over 20 kB. */</span></div>
<div class="line"><span class="preprocessor">#define CMD_WLAN 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_WLAN_STOP 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_WLAN_STATUS 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_WLAN_CONNECT 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_WLAN_IPCONFIG 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_WLAN_DISCONNECT 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_WLAN_START 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_NVMEM 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_NVMEM_SP 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_NVMEM_READ 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_NVMEM_MAC 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_INFO 1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_HELP 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if NO_HELP - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define HELP_STRING(h_) NULL</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#else </span><span class="comment">/* NO_HELP */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define HELP_STRING(h_) h_</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* NO_HELP */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MAGIC_CONNECT_PARAMS 0x3000</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>sConnectParams {</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> magic;</div>
<div class="line">  <span class="keywordtype">int</span> security_type;</div>
<div class="line">  <span class="keywordtype">size_t</span> ssid_len;</div>
<div class="line">  <span class="keywordtype">size_t</span> passphrase_len;</div>
<div class="line">  <span class="keywordtype">char</span> ssid[33];</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> passphrase[65];</div>
<div class="line">} sConnectParams;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> wlan_cb (<span class="keywordtype">long</span> event_type,</div>
<div class="line">                     <span class="keywordtype">char</span> * data,</div>
<div class="line">                     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> length)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%s wlan_cb %#lx %u at %p SR %#x\n&quot;</span>,</div>
<div class="line">          <a class="code" href="uptime_8h.html#a790fc3c41c4a8e93ec7caca7825733c1">xBSP430uptimeAsText_ni</a>(<a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>()),</div>
<div class="line">          event_type, length, data, __read_status_register());</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> * commandSet;</div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND NULL</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND NULL</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_STOP - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_stop (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  wlan_stop();</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_stop = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;stop&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# shut down CC3000&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_stop</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_stop</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_STOP */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_DISCONNECT - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_disconnect (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">long</span> rl = wlan_disconnect();</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;disconnect returned %ld\n&quot;</span>, rl);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_disconnect = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;disconnect&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# disconnect from AP&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_disconnect</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_disconnect</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_DISCONNECT */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_IPCONFIG - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">const</span> <span class="keywordtype">char</span> *</div>
<div class="line">ipv4AsText (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * ipaddr)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">char</span> buffer[16];</div>
<div class="line">  snprintf(buffer, <span class="keyword">sizeof</span>(buffer), <span class="stringliteral">&quot;%u.%u.%u.%u&quot;</span>, ipaddr[3], ipaddr[2], ipaddr[1], ipaddr[0]);</div>
<div class="line">  <span class="keywordflow">return</span> buffer;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_ipconfig (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  tNetappIpconfigRetArgs ipc;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * p;</div>
<div class="line"></div>
<div class="line">  memset(&amp;ipc, 0, <span class="keyword">sizeof</span>(ipc));</div>
<div class="line">  netapp_ipconfig(&amp;ipc);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;IP: %s\n&quot;</span>, ipv4AsText(ipc.aucIP));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;NM: %s\n&quot;</span>, ipv4AsText(ipc.aucSubnetMask));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;GW: %s\n&quot;</span>, ipv4AsText(ipc.aucDefaultGateway));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;DHCP: %s\n&quot;</span>, ipv4AsText(ipc.aucDHCPServer));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;DNS: %s\n&quot;</span>, ipv4AsText(ipc.aucDNSServer));</div>
<div class="line">  p = ipc.uaMacAddr;</div>
<div class="line">  <span class="comment">/* WTF?  A little-endian MAC address?  This may be because of a bug</span></div>
<div class="line"><span class="comment">   * fix in the host driver; the original version was completely</span></div>
<div class="line"><span class="comment">   * wrong. */</span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;MAC: %02x.%02x.%02x.%02x.%02x.%02x\n&quot;</span>,</div>
<div class="line">          p[5], p[4], p[3], p[2], p[1], p[0]);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;SSID: %s\n&quot;</span>, ipc.uaSSID);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_ipconfig = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;ipconfig&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# show IP parameters&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_ipconfig</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_ipconfig</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_IPCONFIG */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_CONNECT - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span>sWlanSecMap {</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> val;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * tag;</div>
<div class="line">} sWlanSecMap;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> sWlanSecMap wlanSecMap[] = {</div>
<div class="line">  { WLAN_SEC_UNSEC, <span class="stringliteral">&quot;unsec&quot;</span> },</div>
<div class="line">  { WLAN_SEC_WEP, <span class="stringliteral">&quot;wep&quot;</span> },</div>
<div class="line">  { WLAN_SEC_WPA, <span class="stringliteral">&quot;wpa&quot;</span> },</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="comment">/* WPA2 is not implemented.  Unit will transmit unsecured auth request */</span></div>
<div class="line">  { WLAN_SEC_WPA2, <span class="stringliteral">&quot;wpa2&quot;</span> },</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* 0 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>};</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> sWlanSecMap * <span class="keyword">const</span> wlanSecMap_end = wlanSecMap + <span class="keyword">sizeof</span>(wlanSecMap)/<span class="keyword">sizeof</span>(*wlanSecMap);</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> sWlanSecMap * wlanSecMapFromValue (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> val)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line">  <span class="keywordflow">for</span> (mp = wlanSecMap; mp &lt; wlanSecMap_end; ++mp) {</div>
<div class="line">    <span class="keywordflow">if</span> (mp-&gt;val == val) {</div>
<div class="line">      <span class="keywordflow">return</span> mp;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> sWlanSecMap * wlanSecMapFromTag (<span class="keyword">const</span> <span class="keywordtype">char</span> * tag)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line">  <span class="keywordflow">for</span> (mp = wlanSecMap; mp &lt; wlanSecMap_end; ++mp) {</div>
<div class="line">    <span class="keywordflow">if</span> (0 == strcmp(mp-&gt;tag, tag)) {</div>
<div class="line">      <span class="keywordflow">return</span> mp;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">sConnectParams connectParams;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_sectype (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> remaining = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">size_t</span> len;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * tp;</div>
<div class="line">  <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line"></div>
<div class="line">  tp = <a class="code" href="group__grp__utility__cli__hci.html#gabcda3dd127008a5cdcc5f40cac4e9e68">xBSP430cliNextQToken</a>(&amp;argstr, &amp;remaining, &amp;len);</div>
<div class="line">  <span class="keywordflow">if</span> (0 &lt; len) {</div>
<div class="line">    mp = wlanSecMapFromTag(tp);</div>
<div class="line">    <span class="keywordflow">if</span> (0 != mp) {</div>
<div class="line">      connectParams.security_type = mp-&gt;val;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: Unrecognized sectype &#39;%s&#39;: valid are&quot;</span>, tp);</div>
<div class="line">      <span class="keywordflow">for</span> (mp = wlanSecMap; mp &lt; wlanSecMap_end; ++mp) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; %s&quot;</span>, mp-&gt;tag);</div>
<div class="line">      }</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  mp = wlanSecMapFromValue(connectParams.security_type);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP security type is %s (%u)\n&quot;</span>, (mp ? mp-&gt;tag : <span class="stringliteral">&quot;&lt;UNDEF&gt;&quot;</span>), connectParams.security_type);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_ssid (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> remaining = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">size_t</span> len;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * tp;</div>
<div class="line"></div>
<div class="line">  tp = <a class="code" href="group__grp__utility__cli__hci.html#gabcda3dd127008a5cdcc5f40cac4e9e68">xBSP430cliNextQToken</a>(&amp;argstr, &amp;remaining, &amp;len);</div>
<div class="line">  <span class="keywordflow">if</span> (0 &lt; len) {</div>
<div class="line">    memcpy(connectParams.ssid, tp, len);</div>
<div class="line">    connectParams.ssid[len] = 0;</div>
<div class="line">    connectParams.ssid_len = len;</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP SSID is %s (%u chars)\n&quot;</span>, connectParams.ssid, connectParams.ssid_len);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_passphrase (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> remaining = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">size_t</span> len;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * tp;</div>
<div class="line"></div>
<div class="line">  tp = <a class="code" href="group__grp__utility__cli__hci.html#gabcda3dd127008a5cdcc5f40cac4e9e68">xBSP430cliNextQToken</a>(&amp;argstr, &amp;remaining, &amp;len);</div>
<div class="line">  <span class="keywordflow">if</span> (0 &lt; len) {</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(connectParams.passphrase) &lt;= (len+1)) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: Passphrase too long (&gt; %u chars + EOS)\n&quot;</span>, <span class="keyword">sizeof</span>(connectParams.passphrase));</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      memcpy(connectParams.passphrase, tp, len);</div>
<div class="line">      connectParams.passphrase[len] = 0;</div>
<div class="line">      connectParams.passphrase_len = len;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP passphrase is &#39;%s&#39; (%u chars)\n&quot;</span>, connectParams.passphrase, connectParams.passphrase_len);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_connect (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">long</span> rl;</div>
<div class="line">  <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t[2];</div>
<div class="line"></div>
<div class="line">  mp = wlanSecMapFromValue(connectParams.security_type);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;connect to ssid &#39;%s&#39; by %s using &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">          connectParams.ssid, (mp ? mp-&gt;tag : <span class="stringliteral">&quot;&lt;UNDEF&gt;&quot;</span>),</div>
<div class="line">          connectParams.passphrase);</div>
<div class="line">  t[0] = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">  rl = wlan_connect(connectParams.security_type,</div>
<div class="line">                    connectParams.ssid, connectParams.ssid_len,</div>
<div class="line">                    NULL,</div>
<div class="line">                    connectParams.passphrase, connectParams.passphrase_len);</div>
<div class="line">  t[1] = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;con %ld in %s\n&quot;</span>, rl, <a class="code" href="uptime_8h.html#a790fc3c41c4a8e93ec7caca7825733c1">xBSP430uptimeAsText_ni</a>(t[1]-t[0]));</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_ssid = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;ssid&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[{ssid}] # Display or set AP SSID for connect&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_ssid</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_passphrase = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;passphrase&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[{passphrase}] # Display or set AP passphrase&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_ssid,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_passphrase</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_sectype = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;sectype&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[{sectype}] # Display or set AP sectype&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_passphrase,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_sectype</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_connect = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;connect&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# connect to specified access point using AP config&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_sectype,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_connect</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_connect</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_CONNECT */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_STATUS - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_status (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">/* Contrary to the documentation, there are no macro constants</span></div>
<div class="line"><span class="comment">   * defined for these states */</span></div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * status_str[] = {</div>
<div class="line">    <span class="stringliteral">&quot;disconnected&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;scanning&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;connecting&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;connected&quot;</span></div>
<div class="line">  };</div>
<div class="line">  <span class="keywordtype">long</span> rl = wlan_ioctl_statusget();</div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_CONNECT - 0</span></div>
<div class="line"><span class="preprocessor"></span>  {</div>
<div class="line">    <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line">    mp = wlanSecMapFromValue(connectParams.security_type);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP configuration SSID &#39;%s&#39;, passphrase &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">            connectParams.ssid, connectParams.passphrase);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP security type %s (%u)\n&quot;</span>, (mp ? mp-&gt;tag : <span class="stringliteral">&quot;&lt;UNDEF&gt;&quot;</span>), connectParams.security_type);</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_CONNECT */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;WLAN status %ld&quot;</span>, rl);</div>
<div class="line">  <span class="keywordflow">if</span> ((0 &lt;= rl) &amp;&amp; (rl &lt; (<span class="keyword">sizeof</span>(status_str)/<span class="keyword">sizeof</span>(*status_str)))) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;: %s&quot;</span>, status_str[rl]);</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a90f7ebaff29b80e288b6890ed9201f2c">cputchar</a>(<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_status = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;status&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# get CC3000 status and AP config&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_status</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_status</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_STATUS */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_WLAN_START - 0</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_start (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t[2];</div>
<div class="line">  t[0] = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">  wlan_start(0);</div>
<div class="line">  t[1] = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;wlan_start() took %s\n&quot;</span>, <a class="code" href="uptime_8h.html#a790fc3c41c4a8e93ec7caca7825733c1">xBSP430uptimeAsText_ni</a>(t[1]-t[0]));</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_start = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;start&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# power-up CC3000&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_wlan_start</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_start</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_START */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;wlan&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .child = LAST_SUB_COMMAND</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_wlan</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND NULL</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (CMD_NVMEM - 0) &amp;&amp; (CMD_NVMEM_SP - 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_nvmem_sp (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> patch_version[2];</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> rv;</div>
<div class="line"></div>
<div class="line">  memset(patch_version, -1, <span class="keyword">sizeof</span>(patch_version));</div>
<div class="line">  rv = nvmem_read_sp_version(patch_version);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;sp ret %u: %u.%u\n&quot;</span>, rv, patch_version[0], patch_version[1]);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem_sp = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;sp&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# read firmware service pack level&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_nvmem_sp</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_nvmem_sp</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_NVMEM_SP */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (CMD_NVMEM - 0) &amp;&amp; (CMD_NVMEM_READ - 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_nvmem_read (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fileid = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len = 128;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ofs = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> data[32];</div>
<div class="line">  <span class="keywordtype">char</span> asciiz[17];</div>
<div class="line">  <span class="keywordtype">char</span> * ap;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> end_read;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ui;</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nb;</div>
<div class="line"></div>
<div class="line">  rc = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;ui);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    fileid = ui;</div>
<div class="line">    rc = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;ui);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    len = ui;</div>
<div class="line">    rc = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;ui);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    ofs = ui;</div>
<div class="line">  }</div>
<div class="line">  end_read = ofs + len;</div>
<div class="line">  memset(asciiz, 0, <span class="keyword">sizeof</span>(asciiz));</div>
<div class="line">  ap = asciiz;</div>
<div class="line">  rc = 0;</div>
<div class="line">  <span class="keywordflow">while</span> ((0 == rc) &amp;&amp; (ofs &lt; end_read)) {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * dp;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * dpe;</div>
<div class="line">    nb = (end_read - ofs);</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(data) &lt; nb) {</div>
<div class="line">      nb = <span class="keyword">sizeof</span>(data);</div>
<div class="line">    }</div>
<div class="line">    rc = nvmem_read(fileid, nb, ofs, data);</div>
<div class="line">    <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">      dp = data;</div>
<div class="line">      dpe = dp + nb;</div>
<div class="line">      <span class="keywordflow">while</span> (dp &lt; dpe) {</div>
<div class="line">        <span class="keywordflow">if</span> (0 == (ofs % 16)) {</div>
<div class="line">          <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;    %s\n%x.%04x &quot;</span>, asciiz, fileid, ofs);</div>
<div class="line">          memset(asciiz, 0, <span class="keyword">sizeof</span>(asciiz));</div>
<div class="line">          ap = asciiz;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 == (ofs % 8)) {</div>
<div class="line">          <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; &quot;</span>);</div>
<div class="line">        }</div>
<div class="line">        ++ofs;</div>
<div class="line">        *ap++ = isprint(*dp) ? *dp : <span class="charliteral">&#39;.&#39;</span>;</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; %02x&quot;</span>, *dp++);</div>
<div class="line">      }</div>
<div class="line">      len -= nb;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;    %s\n&quot;</span>, asciiz);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\nERR: Read returned %u for %u bytes at %u of fileid %u\n&quot;</span>,</div>
<div class="line">            rc, nb, ofs, fileid);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem_read = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;read&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;fileid [len(=128) [ofs(=0)]] # read block from nvmem file&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_nvmem_read</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_nvmem_read</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_NVMEM_READ */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (CMD_NVMEM - 0) &amp;&amp; (CMD_NVMEM_MAC - 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_nvmem_mac (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> mac[6];</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Could extend this to parse &quot;set {addr}&quot; if you wanted. */</span></div>
<div class="line">  rc = nvmem_get_mac_address(mac);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;nvmem mac is %02x.%02x.%02x.%02x.%02x.%02x\n&quot;</span>,</div>
<div class="line">            mac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: nvmem mac read got %u\n&quot;</span>, rc);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem_mac = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;mac&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# get mac address&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_nvmem_mac</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_nvmem_mac</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_NVMEM_MAC */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (CMD_NVMEM - 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;nvmem&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .child = LAST_SUB_COMMAND</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_nvmem</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_SUB_COMMAND NULL</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_NVMEM */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if ! (BSP430_MODULE_FLASH - 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="comment">/* No support for this on FRAM boards yet */</span></div>
<div class="line"><span class="preprocessor">#undef CMD_INFO</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if CMD_INFO - 0</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keyword">static</span> sConnectParams * <span class="keyword">const</span> infoConnectParams = (sConnectParams *)__infob;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_info_load (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (MAGIC_CONNECT_PARAMS != infoConnectParams-&gt;magic) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: Stored connection params invalid\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN_CONNECT - 0)</span></div>
<div class="line"><span class="preprocessor"></span>  connectParams = *infoConnectParams;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_CONNECT */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_info_erase_ni (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Erasing stored params at %p...&quot;</span>, infoConnectParams);</div>
<div class="line">  rv = <a class="code" href="flash_8h.html#a94c76cef12d30a8fb476cb7664338285">iBSP430flashEraseSegment_ni</a>(infoConnectParams);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%d\n&quot;</span>, rv);</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_info_erase (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  <a class="code" href="core_8h.html#a15976e4890ec6eacf5cbddf25c5b11c7">BSP430_CORE_INTERRUPT_STATE_T</a> istate;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ae4bfa3ada65bbdf28947828ce7966ec1">BSP430_CORE_SAVE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    rv = cmd_info_erase_ni();</div>
<div class="line">  } <span class="keywordflow">while</span> (0);</div>
<div class="line">  <a class="code" href="core_8h.html#a5e9ec46fa426727b23b14cd505e5bbec">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_info_store (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#a15976e4890ec6eacf5cbddf25c5b11c7">BSP430_CORE_INTERRUPT_STATE_T</a> istate;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ae4bfa3ada65bbdf28947828ce7966ec1">BSP430_CORE_SAVE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    rv = cmd_info_erase_ni();</div>
<div class="line">    <span class="keywordflow">if</span> (0 == rv) {</div>
<div class="line">      connectParams.magic = MAGIC_CONNECT_PARAMS;</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Copying current configuration...&quot;</span>);</div>
<div class="line">      rv = <a class="code" href="flash_8h.html#ae8561ad078b62fd3ceadabbe69421d5a">iBSP430flashWriteData_ni</a>(infoConnectParams, &amp;connectParams, <span class="keyword">sizeof</span>(connectParams));</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%d\n&quot;</span>, rv);</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">while</span> (0);</div>
<div class="line">  <a class="code" href="core_8h.html#a5e9ec46fa426727b23b14cd505e5bbec">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_info_store = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;store&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# store wlan AP params in INFO_B&quot;</span>),</div>
<div class="line">  .next = NULL,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_info_store</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_info_erase = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;erase&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# erase INFO_B&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_info_store,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_info_erase</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_info_load = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;load&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# load wlan AP params from INFO_B&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_info_erase,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param = cmd_info_load</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_info = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;info&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .child = &amp;dcmd_info_load</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_info</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_INFO */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (CMD_HELP - 0)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_help (<a class="code" href="structsBSP430cliCommandLink.html">sBSP430cliCommandLink</a> * chain,</div>
<div class="line">          <span class="keywordtype">void</span> * param,</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">char</span> * command,</div>
<div class="line">          <span class="keywordtype">size_t</span> command_len)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="group__grp__utility__cli__cli.html#ga2c3a36a00ea6f676cf2006859364d45a">vBSP430cliConsoleDisplayHelp</a>(chain-&gt;<a class="code" href="structsBSP430cliCommandLink.html#a1abd6b2e5174e42795a7c73191732520">cmd</a>);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_help = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;help&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = cmd_help</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_help</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* CMD_HELP */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="keywordtype">void</span> main (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * command;</div>
<div class="line">  <span class="keywordtype">int</span> flags;</div>
<div class="line"><span class="preprocessor">#if BSP430_MODULE_SYS - 0</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> reset_causes = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> reset_flags = 0;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_MODULE_SYS */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if BSP430_MODULE_SYS - 0</span></div>
<div class="line"><span class="preprocessor"></span>  {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sysrstiv;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Record all the reset causes */</span></div>
<div class="line">    <span class="keywordflow">while</span> (0 != ((sysrstiv = <a class="code" href="sys_8h.html#a49bc446977f788990eaf4de3e3b3d234">uiBSP430sysSYSRSTGenerator_ni</a>(&amp;reset_flags)))) {</div>
<div class="line">      reset_causes |= 1UL &lt;&lt; (sysrstiv / 2);</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#ifdef BSP430_PMM_ENTER_LPMXp5_NI</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="comment">/* If we woke from LPMx.5, we need to clear the lock in PM5CTL0.</span></div>
<div class="line"><span class="comment">     * We&#39;ll do it early, since we&#39;re not really interested in</span></div>
<div class="line"><span class="comment">     * retaining the current IFG settings. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_LPM5WU) {</div>
<div class="line">      PMMCTL0_H = PMMPW_H;</div>
<div class="line">      PM5CTL0 = 0;</div>
<div class="line">      PMMCTL0_H = 0;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PMM_ENTER_LPMXp5_NI */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>  }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_MODULE_SYS */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">  <a class="code" href="platform_8h.html#a616515ce5e0f7635ca36a815841d2a21">vBSP430platformInitialize_ni</a>();</div>
<div class="line">  (void)<a class="code" href="console_8h.html#a91f5f68fa2ee29ca39bf9a23ea98cbe1">iBSP430consoleInitialize</a>();</div>
<div class="line">  <a class="code" href="cli_8h.html#a0a5b3cee7e2d9002d5d301b36c814d55">vBSP430cliSetDiagnosticFunction</a>(<a class="code" href="group__grp__utility__cli__cli.html#ga30922f40d6b2702628bb88d9e0069caf">iBSP430cliConsoleDiagnostic</a>);</div>
<div class="line">  <a class="code" href="core_8h.html#a327cb5d1a1607c19c9551a18507bbb63">BSP430_CORE_DELAY_CYCLES</a>(<a class="code" href="clock_8h.html#a6ffd3f4fab35b64d0e8ff8d3179d69d9">BSP430_CLOCK_NOMINAL_MCLK_HZ</a> / 2);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\ncc3000 &quot;</span> __DATE__ <span class="stringliteral">&quot; &quot;</span> __TIME__ <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if BSP430_MODULE_SYS - 0</span></div>
<div class="line"><span class="preprocessor"></span>  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;System reset bitmask %lx; causes:\n&quot;</span>, reset_causes);</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">int</span> bit = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (bit &lt; (8 * <span class="keyword">sizeof</span>(reset_causes))) {</div>
<div class="line">      <span class="keywordflow">if</span> (reset_causes &amp; (1UL &lt;&lt; bit)) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\t%s\n&quot;</span>, <a class="code" href="sys_8h.html#a2012d634fbc0045a010a2158b37248f2">xBSP430sysSYSRSTIVDescription</a>(2*bit));</div>
<div class="line">      }</div>
<div class="line">      ++bit;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot;System reset included:&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (reset_flags) {</div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_BOR) {</div>
<div class="line">      <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; BOR&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_LPM5WU) {</div>
<div class="line">      <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; LPM5WU&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_POR) {</div>
<div class="line">      <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; POR&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_PUC) {</div>
<div class="line">      <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; PUC&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="console_8h.html#a90148fb44b9e9b2b952d6ba8e42b317d">cputtext_ni</a>(<span class="stringliteral">&quot; no data&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a46ea793d7dd79b66e1c3a195d0d4a7b1">cputchar_ni</a>(<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_MODULE_SYS */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#if (BSP430_MODULE_PMM - 0) &amp;&amp; ! (BSP430_MODULE_PMM_FRAM - 0)</span></div>
<div class="line"><span class="preprocessor"></span>  rv = <a class="code" href="pmm_8h.html#ac3621d45ad0e516384a5dce097dadba9">iBSP430pmmSetCoreVoltageLevel_ni</a>(PMMCOREV_3);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Vcore at %d\n&quot;</span>, rv);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;PWR_EN at %s.%u\n&quot;</span>, <a class="code" href="port_8h.html#a78a791b05b428f3aa2bf5ff09e907200">xBSP430portName</a>(<a class="code" href="rfem_8h.html#a8ef1d1dc188b30379f946635a3920f07">BSP430_RFEM_PWR_EN_PORT_PERIPH_HANDLE</a>), <a class="code" href="port_8h.html#aa9b72a778f0f690c08bba27871c4d374">iBSP430portBitPosition</a>(<a class="code" href="rfem_8h.html#a02b8877017074eff5126882bdee9f840">BSP430_RFEM_PWR_EN_PORT_BIT</a>));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;SPI_IRQ HAL at %s.%u\n&quot;</span>, <a class="code" href="port_8h.html#a78a791b05b428f3aa2bf5ff09e907200">xBSP430portName</a>(<a class="code" href="rfem_8h.html#a526c15df0b78d0e456a1d8777a47ec43">BSP430_RFEM_SPI_IRQ_PORT_PERIPH_HANDLE</a>), <a class="code" href="port_8h.html#aa9b72a778f0f690c08bba27871c4d374">iBSP430portBitPosition</a>(<a class="code" href="rfem_8h.html#a2d4b63fe5eaa2695edfbd8ed4058b119">BSP430_RFEM_SPI_IRQ_PORT_BIT</a>));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;CSn HAL at %s.%u\n&quot;</span>, <a class="code" href="port_8h.html#a78a791b05b428f3aa2bf5ff09e907200">xBSP430portName</a>(<a class="code" href="rfem_8h.html#af2db206437914504f599c7edd1aa6443">BSP430_RFEM_SPI0CSn_PORT_PERIPH_HANDLE</a>), <a class="code" href="port_8h.html#aa9b72a778f0f690c08bba27871c4d374">iBSP430portBitPosition</a>(<a class="code" href="rfem_8h.html#ac34b2d6647910584c94c65e19cae23f4">BSP430_RFEM_SPI0CSn_PORT_BIT</a>));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;SPI is %s\n&quot;</span>, <a class="code" href="serial_8h.html#a7f2e6f39abd1faca343663917e34840a">xBSP430serialName</a>(<a class="code" href="rfem_8h.html#a591494d7035a46d6f8e7d47151378b84">BSP430_RFEM_SPI0_PERIPH_HANDLE</a>));</div>
<div class="line"><span class="preprocessor">#if BSP430_PLATFORM_PERIPHERAL_HELP</span></div>
<div class="line"><span class="preprocessor"></span>  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;SPI Pins: %s\n&quot;</span>, <a class="code" href="platform_8h.html#ad5df0a450196592bc395c5efe89a6fb3">xBSP430platformPeripheralHelp</a>(<a class="code" href="rfem_8h.html#a591494d7035a46d6f8e7d47151378b84">BSP430_RFEM_SPI0_PERIPH_HANDLE</a>, <a class="code" href="periph_8h.html#a5a28880814f93f755ea189df4e2d1900">BSP430_PERIPHCFG_SERIAL_SPI3</a>));</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PLATFORM_PERIPHERAL_HELP */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span>  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(__DATE__ <span class="stringliteral">&quot; &quot;</span> __TIME__ <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Initialization can be done with interrupts disabled, since the</span></div>
<div class="line"><span class="comment">   * function does nothing but store callbacks. */</span></div>
<div class="line">  rv = <a class="code" href="cc3000spi_8h.html#a18c48988f94c6984548d28e802377344">iBSP430cc3000spiInitialize</a>(wlan_cb, NULL, NULL, NULL);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%s Initialize returned %d\n&quot;</span>, <a class="code" href="uptime_8h.html#a790fc3c41c4a8e93ec7caca7825733c1">xBSP430uptimeAsText_ni</a>(<a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>()), rv);</div>
<div class="line"></div>
<div class="line">  commandSet = LAST_COMMAND;</div>
<div class="line">  command = NULL;</div>
<div class="line">  flags = <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deaf4a31c8e1956488e1ff37d22d55936b3">eBSP430cliConsole_REPAINT</a>;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#a954f39fe5652611f5a20f74289b0cfbf">BSP430_CORE_ENABLE_INTERRUPT</a>();</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* wlan_start() MUST be invoked with interrupts enabled. */</span></div>
<div class="line">  wlan_start(0);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\nAnd wlan has been started.\n&quot;</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if CMD_INFO - 0</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (0 == cmd_info_load(<span class="stringliteral">&quot;&quot;</span>)) {</div>
<div class="line">    cmd_wlan_status(<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line">  <span class="keywordflow">while</span> (1) {</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deafdfdebe7b8568728238e4069ae19cd09">eBSP430cliConsole_DO_COMPLETION</a>) {</div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_DO_COMPLETION;</div>
<div class="line">      flags |= <a class="code" href="group__grp__utility__cli__completion.html#ga5086d946e412fa4e9928819d664fc2cc">iBSP430cliConsoleBufferCompletion</a>(commandSet, &amp;command);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69dea09d4c7792c3db363181260eebd086d94">eBSP430cliConsole_READY</a>) {</div>
<div class="line">      <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">      rv = <a class="code" href="cli_8h.html#adcdb159a40c5cb6737cf97b497b58a55">iBSP430cliExecuteCommand</a>(commandSet, 0, command);</div>
<div class="line">      <span class="keywordflow">if</span> (0 != rv) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Command execution returned %d\n&quot;</span>, rv);</div>
<div class="line">      }</div>
<div class="line">      <span class="comment">/* Ensure prompt is rewritten, but not the command we just</span></div>
<div class="line"><span class="comment">       * ran */</span></div>
<div class="line">      flags |= <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deaf4a31c8e1956488e1ff37d22d55936b3">eBSP430cliConsole_REPAINT</a>;</div>
<div class="line">      command = NULL;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deaf4a31c8e1956488e1ff37d22d55936b3">eBSP430cliConsole_REPAINT</a>) {</div>
<div class="line">      <span class="comment">/* Draw the prompt along with whatever&#39;s left in the command buffer */</span></div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;&gt; %s&quot;</span>, command ? command : <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_REPAINT;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69dea1af184228ab718533ff1ef6a1b4f5a8b">eBSP430cliConsole_REPAINT_BEL</a>) {</div>
<div class="line">      <a class="code" href="console_8h.html#a90f7ebaff29b80e288b6890ed9201f2c">cputchar</a>(<span class="charliteral">&#39;\a&#39;</span>);</div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_REPAINT_BEL;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; eBSP430cliConsole_READY) {</div>
<div class="line">      <span class="comment">/* Clear the command we just completed */</span></div>
<div class="line">      <a class="code" href="group__grp__utility__cli__cli.html#ga851a3ff12f32fc07f0e83b084dbd659d">vBSP430cliConsoleBufferClear_ni</a>();</div>
<div class="line">    }</div>
<div class="line">    flags = <a class="code" href="group__grp__utility__cli__cli.html#ga0dc701d6a0e8678616dbdc43219f2628">iBSP430cliConsoleBufferProcessInput_ni</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (flags) {</div>
<div class="line">      <span class="comment">/* Got something to do; get the command contents in place */</span></div>
<div class="line">      command = <a class="code" href="group__grp__utility__cli__cli.html#gad0d2c92b96b17302159c049f7a9bfb17">xBSP430cliConsoleBuffer_ni</a>();</div>
<div class="line">      <a class="code" href="core_8h.html#a954f39fe5652611f5a20f74289b0cfbf">BSP430_CORE_ENABLE_INTERRUPT</a>();</div>
<div class="line">      <span class="keywordflow">continue</span>;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="core_8h.html#ab3ba0bc9be345eb561a58747da602704">BSP430_CORE_LPM_ENTER_NI</a>(<a class="code" href="msp430_8h.html#a8af1e5b3633693d9439d284100183004">LPM2_bits</a>);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="ex_rfem_cc3000_config"></a>
bsp430_config.h</h1>
<div class="fragment"><div class="line"><span class="comment">/* Use a crystal if one is installed.  Much more accurate timing</span></div>
<div class="line"><span class="comment"> * results. */</span></div>
<div class="line"><span class="preprocessor">#define BSP430_PLATFORM_BOOT_CONFIGURE_LFXT1 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Application does output: support spin-for-jumper */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_PLATFORM_SPIN_FOR_JUMPER 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Support console output */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_CONSOLE 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Enable an 8-character rx buffer for the console */</span></div>
<div class="line"><span class="preprocessor">#define BSP430_CONSOLE_RX_BUFFER_SIZE 8</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Enable an 80-character command buffer */</span></div>
<div class="line"><span class="preprocessor">#define BSP430_CLI_CONSOLE_BUFFER_SIZE 80</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Enable completion */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_CLI_COMMAND_COMPLETION 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Monitor uptime and provide generic ACLK-driven timer */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_UPTIME 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Request RFEM interface resources */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_RFEM 1</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* Get platform defaults */</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="bsp430__config_8h.html" title="BSP430 application and platform configuration directives.">bsp430/platform/bsp430_config.h</a>&gt;</span></div>
</div><!-- fragment --><h1><a class="anchor" id="ex_rfem_cc3000_make"></a>
Makefile</h1>
<div class="fragment"><div class="line">PLATFORM ?= exp430f5438</div>
<div class="line">MODULES=$(MODULES_PLATFORM)</div>
<div class="line">MODULES += $(MODULES_UPTIME)</div>
<div class="line">MODULES += $(MODULES_CONSOLE)</div>
<div class="line">MODULES += periph/port</div>
<div class="line">MODULES += periph/sys</div>
<div class="line">MODULES += periph/flash</div>
<div class="line">MODULES += utility/cli</div>
<div class="line"></div>
<div class="line"># Set <span class="keyword">this</span> to where you installed the cc3000 library</div>
<div class="line">CC3000_ROOT ?= /usr/local/msp430-cc3000-dev</div>
<div class="line"></div>
<div class="line"># Tell BSP430<span class="stringliteral">&#39;s build infrastructure about the library.</span></div>
<div class="line"><span class="stringliteral">AUX_CPPFLAGS=-I$(CC3000_ROOT)/include</span></div>
<div class="line"><span class="stringliteral">AUX_LDFLAGS=-L$(CC3000_ROOT)/lib</span></div>
<div class="line"><span class="stringliteral">AUX_LDLIBS=-lcc3000</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">SRC=cc3000spi.c main.c</span></div>
<div class="line"><span class="stringliteral">include $(BSP430_ROOT)/examples/Makefile.common</span></div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Mar 25 2013 11:56:36 for BSP430 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.2
</small></address>
</body>
</html>
